variables:
  NODE_VERSION: "22.9.0"
  NODE_DIST: "linux-x64"

default:
  cache:
    key: ${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/node
      - node_modules/
  before_script:
    - export NODE_DIR="$CI_PROJECT_DIR/.cache/node"
    - if [ ! -x "$NODE_DIR/bin/node" ] || [ "$($NODE_DIR/bin/node -v 2>/dev/null)" != "v${NODE_VERSION}" ]; then rm -rf "$NODE_DIR"; mkdir -p "$NODE_DIR"; curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-${NODE_DIST}.tar.xz" -o node.tar.xz; tar -xJf node.tar.xz -C "$NODE_DIR" --strip-components=1; rm node.tar.xz; fi
    - export PATH="$NODE_DIR/bin:$PATH"
    - node -v
    - npm -v
    - npx yarn@1.22.22 install --frozen-lockfile

stages:
  - build
  - deploy

build:
  stage: build
  script:
    - npx yarn@1.22.22 build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "master"
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG

publish:
  stage: deploy
  needs:
    - job: build
      artifacts: true
  script:
    - echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" > .npmrc
    - npm publish
  rules:
    - if: $CI_COMMIT_TAG
