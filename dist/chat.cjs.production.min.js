"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t,a,n,r=require("react"),o=e(r),l=require("@mui/material"),s=require("@mui/styles"),i=e(require("@mui/icons-material/FileCopy")),c=e(require("@mui/icons-material/Delete")),u=e(require("@mui/icons-material/ArrowBack")),d=require("@mui/icons-material"),m=require("react-i18next"),p=e(require("@mui/icons-material/Group")),E=e(require("@mui/icons-material/CallEnd")),g=e(require("@mui/icons-material/PersonAdd")),f=e(require("@mui/icons-material/Star")),h=e(require("dayjs")),y=require("@mui/material/styles"),C=e(require("@mui/material/Button")),T=e(require("@mui/material/Menu")),v=e(require("@mui/material/MenuItem")),R=e(require("@mui/icons-material/PlayArrow")),I=e(require("@mui/icons-material/RestartAlt")),S=e(require("@mui/icons-material/VideoCall")),A=e(require("@mui/icons-material/KeyboardArrowDown")),O=e(require("@mui/material/Dialog")),N=e(require("@mui/material/DialogActions")),x=e(require("@mui/material/DialogContent")),_=e(require("@mui/material/Slide")),b=require("react-aspect-ratio"),G=e(require("react-infinite-scroller")),k=e(require("@mui/material/List")),D=e(require("axios")),M=e(require("socket.io-client")),w=e(require("@mui/icons-material/SettingsSuggest")),U=e(require("@mui/icons-material/SettingsVoice")),L=e(require("@mui/icons-material/VideoSettings")),P=e(require("i18next")),j=e(require("i18next-browser-languagedetector"));(t=exports.MessageStatus||(exports.MessageStatus={}))[t.sent=0]="sent",t[t.read=1]="read",(a=exports.Role||(exports.Role={}))[a.Unknown=0]="Unknown",a[a.Client=1]="Client",a[a.Agent=2]="Agent",a[a.Specialist=3]="Specialist",a[a.Operator=4]="Operator",(n=exports.ContextMenuType||(exports.ContextMenuType={})).COPY="COPY",n.REVOKE="REVOKE",n.TOP_REVERT="TOP_REVERT",n.TOP="TOP",n.READ="READ",n.DELETE="DELETE";const F=s.makeStyles(()=>s.createStyles({item:{cursor:"pointer"}})),H=e=>{const t=F(),a=t=>{e.onSelect&&e.onSelect(t.target.innerText)},n=e=>r.createElement(l.Box,{m:.5,component:"span",onClick:a,className:t.item},e.emoji);return r.createElement(l.Box,null,r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😃"}),r.createElement(n,{emoji:"😁"}),r.createElement(n,{emoji:"😂"}),r.createElement(n,{emoji:"😄"}),r.createElement(n,{emoji:"😅"}),r.createElement(n,{emoji:"😆"}),r.createElement(n,{emoji:"😇"}),r.createElement(n,{emoji:"😈"}),r.createElement(n,{emoji:"😉"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😊"}),r.createElement(n,{emoji:"😋"}),r.createElement(n,{emoji:"😌"}),r.createElement(n,{emoji:"😍"}),r.createElement(n,{emoji:"😎"}),r.createElement(n,{emoji:"😏"}),r.createElement(n,{emoji:"😐"}),r.createElement(n,{emoji:"😒"}),r.createElement(n,{emoji:"😓"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"❓"}),r.createElement(n,{emoji:"😕"}),r.createElement(n,{emoji:"😖"}),r.createElement(n,{emoji:"😗"}),r.createElement(n,{emoji:"😘"}),r.createElement(n,{emoji:"😙"}),r.createElement(n,{emoji:"😚"}),r.createElement(n,{emoji:"😜"}),r.createElement(n,{emoji:"😝"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😞"}),r.createElement(n,{emoji:"😟"}),r.createElement(n,{emoji:"😠"}),r.createElement(n,{emoji:"😡"}),r.createElement(n,{emoji:"😢"}),r.createElement(n,{emoji:"😣"}),r.createElement(n,{emoji:"😤"}),r.createElement(n,{emoji:"😥"}),r.createElement(n,{emoji:"😦"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😨"}),r.createElement(n,{emoji:"😩"}),r.createElement(n,{emoji:"😪"}),r.createElement(n,{emoji:"😫"}),r.createElement(n,{emoji:"😬"}),r.createElement(n,{emoji:"😭"}),r.createElement(n,{emoji:"😮"}),r.createElement(n,{emoji:"😯"}),r.createElement(n,{emoji:"😰"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😲"}),r.createElement(n,{emoji:"😳"}),r.createElement(n,{emoji:"😴"}),r.createElement(n,{emoji:"😵"}),r.createElement(n,{emoji:"🧐"}),r.createElement(n,{emoji:"😷"}),r.createElement(n,{emoji:"🙁"}),r.createElement(n,{emoji:"🙂"}),r.createElement(n,{emoji:"🙃"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"🤐"}),r.createElement(n,{emoji:"🤑"}),r.createElement(n,{emoji:"🤒"}),r.createElement(n,{emoji:"🤓"}),r.createElement(n,{emoji:"🤔"}),r.createElement(n,{emoji:"🤕"}),r.createElement(n,{emoji:"🤠"}),r.createElement(n,{emoji:"🤡"}),r.createElement(n,{emoji:"🤢"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"🤤"}),r.createElement(n,{emoji:"🤥"}),r.createElement(n,{emoji:"🤧"}),r.createElement(n,{emoji:"🤨"}),r.createElement(n,{emoji:"🤩"}),r.createElement(n,{emoji:"🤪"}),r.createElement(n,{emoji:"🤫"}),r.createElement(n,{emoji:"🤬"}),r.createElement(n,{emoji:"🤭"})))},B=s.makeStyles(e=>s.createStyles({typingText:{paddingLeft:e.spacing(.5)},typingDot:{display:"inline-block",verticalAlign:"middle",width:4,height:4,margin:"0px 2px",background:e.palette.primary.main,borderRadius:"50%",opacity:"0",animation:"$loadingFade 1s infinite","&:nth-child(1)":{animationDelay:"0s"},"&:nth-child(2)":{animationDelay:"0.2s"},"&:nth-child(3)":{animationDelay:"0.4s"}},"@keyframes loadingFade":{"0%":{opacity:0},"50%":{opacity:.8},"100%":{opacity:0}}})),z=e=>{const t=B();return o.createElement(l.Typography,{color:"primary",variant:"body2",component:"span"},o.createElement("span",{className:t.typingDot}),o.createElement("span",{className:t.typingDot}),o.createElement("span",{className:t.typingDot}),o.createElement("span",{className:t.typingText},e.message))},V=s.makeStyles(()=>({input:{flex:"auto"},inputUpload:{display:"none"},attachmentIcon:{fill:"none",stroke:"currentColor"}})),Y=e=>{const t=V(),{chat:a}=e,{t:n}=m.useTranslation(),[r,s]=o.useState(null),[i,c]=o.useState(""),[u,p]=o.useState({chat:a,time:0}),E=()=>{s(null)},g=t=>{a&&e.onSendMessage&&e.onSendMessage(a,t)},f=()=>{0!==i.trim().length&&(g({message:i,messageType:"text"}),c(""))},h=Boolean(r),y=h?"simple-popover":void 0;return o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement(l.TextField,{className:t.input,placeholder:n("CHAT.INPUT_MESSAGE")||"",autoFocus:!0,variant:"standard",InputProps:{disableUnderline:!0,startAdornment:o.createElement(l.InputAdornment,{position:"start"},o.createElement("input",{accept:".pdf,.jpg,.jpeg,.bmp,.gif,.png,application/pdf,image/jpeg,image/bmp,image/gif,image/png",className:t.inputUpload,id:"icon-button-file",type:"file",onChange:e=>{if(!e.currentTarget.files)return;const t=e.currentTarget.files[0];let a;if(a=t.type.includes("image")?"image":t.type.includes("video")?"video":"file","image"===a){const e=new Image,n=window.URL||window.webkitURL;e.src=n.createObjectURL(t),e.onload=()=>{const n=(e=>{let{width:t,height:a}=e;return(t>335||a>335)&&(t>a?(a=a/t*335,t=335):(t=t/a*335,a=335)),{width:t,height:a}})({width:e.width,height:e.height});g({message:t,width:n.width,height:n.height,messageType:a})}}else g({message:t,messageType:a,fileName:t.name,size:t.size})}}),o.createElement("label",{htmlFor:"icon-button-file"},o.createElement(l.IconButton,{color:"primary","aria-label":"upload",component:"span",size:"small"},o.createElement(l.SvgIcon,{fill:"none",className:t.attachmentIcon},o.createElement("path",{d:"M16.768 13.5767L11.6961 18.6486C9.35886 20.9859 5.56937 20.9859 3.23208 18.6486V18.6486C0.894789 16.3114 0.894789 12.5219 3.23208 10.1846L10.4479 2.96872C12.0875 1.32914 14.7458 1.32914 16.3854 2.96873V2.96873C18.025 4.60831 18.025 7.26659 16.3854 8.90617L9.16515 16.1264C8.23032 17.0612 6.71466 17.0612 5.77982 16.1264V16.1264C4.84499 15.1916 4.84499 13.6759 5.77982 12.7411L10.8896 7.63131",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}))))," ",o.createElement(l.IconButton,{"aria-describedby":y,onClick:e=>{s(e.currentTarget)},color:"primary",size:"small"},o.createElement(d.InsertEmoticon,null))),endAdornment:o.createElement(l.IconButton,{edge:"end",color:"inherit",size:"small",onClick:e=>{e.preventDefault(),f()}},o.createElement(d.Send,null))},value:i,onChange:t=>{let{target:n}=t;c(n.value),a&&e.onTyping&&(u.chat!==a||Date.now()-u.time>=500)&&(p({chat:a,time:Date.now()}),e.onTyping(a))},onKeyPress:e=>{"Enter"===e.key&&(e.preventDefault(),f())}}),o.createElement(l.Popover,{id:y,open:h,anchorEl:r,onClose:E,anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"left"}},o.createElement(H,{onSelect:e=>{c(""+i+e),E()}})))},q=e=>{const{t:t}=m.useTranslation();return e.isTyping?o.createElement(z,{message:t("CHAT.STATUS.TYPING")}):1===e.contact.online?o.createElement(l.Typography,{variant:"body2",color:"primary",component:"span"},t("CHAT.STATUS.ONLINE")):o.createElement(l.Typography,{variant:"body2",color:"textSecondary",component:"span"},t("CHAT.STATUS.OFFLINE"))};function K(e){return null==e||"object"==typeof e&&0===Object.keys(e).length||"string"==typeof e&&0===e.trim().length}function W(e,t){return void 0===t&&(t="DD.MM.YYYY HH:mm"),void 0===e?null:("string"==typeof e&&(e=new Date(e)),h().add(-1,"days").startOf("day").isAfter(e)?h(e).format(t):h().startOf("day").isAfter(e)?"Вчера в "+h(e).format("HH:mm"):h(e).format("HH:mm"))}const J=e=>e?e.groupId?"group:"+e.groupId:"user:"+e.userId:null,$=e=>e.groupId?e.name:e.username,X=(e,t)=>{const a=Array.isArray(e.messages)&&e.messages.length>0,n=Array.isArray(t.messages)&&t.messages.length>0;return a&&n&&null!=t.messages&&null!=e.messages?(null!=t.messages[t.messages.length-1].cdate?new Date(t.messages[t.messages.length-1].cdate).getTime():(new Date).getTime())-(null!=e.messages[e.messages.length-1].cdate?new Date(e.messages[e.messages.length-1].cdate).getTime():(new Date).getTime()-1):a?-1:1},Q=e=>{const t=window.location.search;return new URLSearchParams(t).get(e)},Z=(e,t,a)=>{const n=t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e;return a?n+(n.includes("?")?"&":"?")+new URLSearchParams(a).toString():n},ee=s.makeStyles(()=>({star:{fontSize:"0.85rem",verticalAlign:"middle"}})),te=e=>{const t=ee(),{apiUrl:a,contacts:n,owner:r}=e;return o.createElement(l.List,{"aria-label":"contacts"},n.map(n=>o.createElement(l.ListItem,{button:!0,key:n.userId,onClick:()=>e.onClick&&e.onClick(n)},o.createElement(l.ListItemAvatar,null,o.createElement(l.Avatar,{alt:n.username,src:n.avatar?Z(a,n.avatar):""})),o.createElement(l.ListItemText,{primary:o.createElement("span",null,n.username," ",r===n.userId&&o.createElement(f,{className:t.star,color:"primary"})),secondary:o.createElement(q,{contact:n,isTyping:!1})}))))},ae=e=>{const{onClose:t,open:a,apiUrl:n,contacts:r}=e,{t:s}=m.useTranslation();return o.createElement(l.Dialog,{onClose:()=>{t()},"aria-labelledby":"add-contact-title",open:a},o.createElement(l.DialogTitle,{id:"switch-operator-title"},s("CHAT.ADD_CONTACT")),o.createElement(te,{apiUrl:n,contacts:r,onClick:e=>{t(e)}}))};function ne(){return(ne=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}const re=o.forwardRef((function(e,t){return o.createElement(l.Slide,ne({direction:"up",ref:t},e))}));function oe(e){let{children:t,open:a,setOpen:n,severity:r="warning"}=e;const{t:s}=m.useTranslation(),i=()=>{n(!1)};return o.createElement(l.Dialog,{open:a,TransitionComponent:re,keepMounted:!0,onClose:i,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description"},o.createElement(l.DialogContent,null,o.createElement(l.Alert,{severity:r},"string"==typeof t?o.createElement(l.Typography,{variant:"body2"},t):t)),o.createElement(l.DialogActions,null,o.createElement(l.Button,{onClick:i,variant:"text"},s("CHAT.BUT_CLOSE"))))}const le=e=>{let{modaleInfo:t,setModaleInfo:a,strTime:n}=e;const{t:s}=m.useTranslation();return r.useMemo(()=>o.createElement(oe,{open:t,setOpen:a,severity:"info"},o.createElement(l.Typography,{variant:"body1",textAlign:"center"},s("CHAT.CONFERENCE.UntillTheEnd"),":"),o.createElement(l.Typography,{variant:"h6",textAlign:"center"},n)),[t])},se=e=>{let{finishDate:t}=e;const{t:a}=m.useTranslation(),[n,s]=r.useState(!1),i=Date.now(),c=new Date(t).getTime(),u=Math.round((c-i)/1e3),{counter:d}=function(e){void 0===e&&(e=3e4);const[t,a]=r.useState(e),n=r.useRef(null);return r.useEffect(()=>(t>0&&(n.current=setInterval(()=>a(e=>e-1),1e3)),()=>{n.current&&clearInterval(n.current)}),[t]),{counter:t,handlerRefresh:()=>{a(e)}}}(u);if(r.useEffect(()=>{null!=p&&3===p&&null!=E&&0===E&&s(!0)},[d]),u<1)return null;const{minutes:p,seconds:E,strTime:g}=(e=>{const t=Math.floor(e/3600),a=t<10?"0"+t:t;e%=3600;const n=Math.floor(e/60),r=e%60;return{hours:t,minutes:n,seconds:r,strTime:a+":"+(n<10?"0"+n:n)+":"+(r<10?"0"+r:r)}})(u);return o.createElement(l.Box,{textAlign:"center"},o.createElement(l.Typography,{variant:"body2",component:"span"},a("CHAT.CONFERENCE.LEFT_TIME"),":"," "),o.createElement(l.Typography,{variant:"button",component:"span"},g),o.createElement(le,{modaleInfo:n,setModaleInfo:s,strTime:g}))},ie=r.forwardRef((function(e,t){return r.createElement(_,ne({direction:"up",ref:t},e))}));function ce(e){let{open:t,setOpen:a,contentText:n,callback:o}=e;const{t:s}=m.useTranslation(),i=()=>{a(!1)};return r.createElement(r.Fragment,null,r.createElement(O,{open:t,TransitionComponent:ie,keepMounted:!0,onClose:i,"aria-describedby":"alert-dialog-slide-description"},r.createElement(x,null,r.createElement(l.Typography,{variant:"h6"},n)),r.createElement(N,null,r.createElement(C,{onClick:i,color:"primary"},s("CHAT.BUT_CLOSE")),r.createElement(C,{onClick:()=>{a(!1),o()},color:"warning"},s("CHAT.BUT_CONFIRM")))))}const ue=y.styled(e=>r.createElement(T,ne({elevation:0,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"}},e)))(e=>{let{theme:t}=e;return{"& .MuiPaper-root":{borderRadius:6,marginTop:t.spacing(1),minWidth:180,color:"light"===t.palette.mode?"rgb(55, 65, 81)":t.palette.grey[300],boxShadow:"rgb(255, 255, 255) 0px 0px 0px 0px, rgba(0, 0, 0, 0.05) 0px 0px 0px 1px, rgba(0, 0, 0, 0.1) 0px 10px 15px -3px, rgba(0, 0, 0, 0.05) 0px 4px 6px -2px","& .MuiMenu-list":{padding:"4px 0"},"& .MuiMenuItem-root":{"& .MuiSvgIcon-root":{fontSize:18,color:t.palette.text.secondary,marginRight:t.spacing(1.5)},"&:active":{backgroundColor:y.alpha(t.palette.primary.main,t.palette.action.selectedOpacity)}}}}});function de(e){const{t:t}=m.useTranslation(),[a,n]=r.useState(null),[o,l]=r.useState(null),[s,i]=r.useState(!1),c=Boolean(a),u=r.useMemo(()=>e.visitData.filter(t=>t.contactId===e.chat.userId),[e.visitData,e.chat]);return r.createElement("div",null,r.createElement(C,{id:"conference-button","aria-controls":c?"conference-menu":void 0,"aria-haspopup":"true","aria-expanded":c?"true":void 0,color:"primary",size:"small",variant:"contained",disableElevation:!0,onClick:e=>{n(e.currentTarget)},startIcon:r.createElement(S,null),endIcon:r.createElement(A,null),disabled:0===u.length},t("CHAT.CONFERENCE.START")),r.createElement(ce,{open:s,setOpen:i,contentText:t("CHAT.CONFERENCE.CONFIRM_RECREATE_CONF"),callback:()=>{o&&s&&e.onVideoCall(e.chat,o,!0)}}),r.createElement(ue,{id:"conference-menu",MenuListProps:{"aria-labelledby":"conference-button"},anchorEl:a,open:c,onClose:()=>{n(null)}},u.map(t=>r.createElement(v,{onClick:()=>(t=>{n(null),l(t.visitId),"finished"===t.conferenceStatus?i(!0):e.onVideoCall(e.chat,t.visitId)})(t),key:t.visitId,value:t.visitId,disableRipple:!0},r.createElement("finished"===t.conferenceStatus?I:R,null),(e=>{const t=new Date(e.visitDate);return e.plExamName+" ("+W(t,"HH:mm")+" - "+W(new Date(t.getTime()+6e4*e.duration),"HH:mm")+")"})(t)))))}const me=s.makeStyles(e=>s.createStyles({popover:{pointerEvents:"none"},paper:{padding:e.spacing(1)},avatarGroup:{backgroundColor:"#28B7C6",color:"#fff"}})),pe=(e,t)=>{var a;const n=[(null==(a=e.members)?void 0:a.length)+" "+t("CHAT.MEMBERS")],r=(e.members||[]).reduce((e,t)=>t.online?e+1:e,0);return r&&n.push(r+" "+t("CHAT.STATUS.ONLINE")),n.join(", ")},Ee=e=>{let{apiUrl:t,user:a,chat:n,typing:s,conference:i,visitData:u,conferenceJoined:d,className:f,operators:h,onVideoCall:y,onVideoEnd:C,onConferencePause:T,onOperatorAdd:v,onLeaveGroup:R}=e;const I=me(),{t:S}=m.useTranslation(),[A,O]=r.useState(null),[N,x]=r.useState(!1);if(!n)return o.createElement(l.CardHeader,{avatar:o.createElement(l.Avatar,null),title:"",subheader:"",className:f});const _=()=>{O(null)},b=n;var G;if(b.groupId)return o.createElement(l.CardHeader,{avatar:o.createElement(l.Avatar,{alt:b.name,className:I.avatarGroup},o.createElement(p,null)),title:b.name,subheader:o.createElement(o.Fragment,null,o.createElement("span",{"aria-owns":A?"mouse-over-popover":void 0,"aria-haspopup":"true",onMouseEnter:e=>{O(e.currentTarget)},onMouseLeave:_},pe(b,S)),o.createElement(l.Popover,{id:"mouse-over-popover",className:I.popover,classes:{paper:I.paper},open:!!A,anchorEl:A,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},onClose:_,disableRestoreFocus:!0},o.createElement(te,{apiUrl:t,contacts:b.members,owner:b.userId}))),className:f,action:o.createElement(o.Fragment,null,4===a.role&&o.createElement(o.Fragment,null,o.createElement(l.IconButton,{"aria-label":"add user",onClick:()=>{x(!0)}},o.createElement(g,null)),o.createElement(ae,{apiUrl:t,open:N,contacts:h,onClose:e=>{x(!1),v&&e&&n&&v(n,e)}})),4===a.role&&(null==(G=b.members)?void 0:G.find(e=>e.userId!==a.userId&&4===e.role))&&R&&o.createElement(l.IconButton,{"aria-label":"leave group",onClick:()=>R(b)},o.createElement(c,null)))});const k=n,D=!(null==s||!s.contactId)&&(null==s?void 0:s.userId)===k.userId;return o.createElement(l.CardHeader,{avatar:o.createElement(l.Avatar,{alt:k.username,src:k.avatar?Z(t,k.avatar):""}),title:k.username,subheader:o.createElement(q,{contact:k,isTyping:D}),className:f,action:o.createElement(o.Fragment,null,1!==a.role&&d&&i&&!K(i)&&null!=T&&o.createElement(l.Button,{"aria-label":"cancel call",variant:"contained",color:"secondary",size:"small",startIcon:o.createElement(E,{color:"error"}),onClick:()=>T(i)},S("CHAT.CONFERENCE.PAUSE")),i&&!K(i)&&null!=C&&null!=a.role&&[3,4].includes(a.role)&&o.createElement(l.Button,{"aria-label":"cancel call",variant:"contained",color:"primary",size:"small",startIcon:o.createElement(E,{color:"error"}),onClick:()=>C(i),style:{marginLeft:8}},S("CHAT.CONFERENCE.FINISH")),K(i)&&null!=y&&a.role&&[3,4].includes(a.role)&&o.createElement(de,{visitData:u,chat:k,onVideoCall:y}),null!=(null==i?void 0:i.finishDate)&&o.createElement(se,{finishDate:i.finishDate}))})},ge=s.makeStyles(e=>s.createStyles({fileIcon:{fontSize:"0.75rem"},fileBody:{paddingLeft:e.spacing(1.2)}})),fe=e=>{let{message:t}=e;const a=ge(),n=function(e){const t=e.split("$"),[a,n,r,o]=t;return{date:a,userId:n,size:r,name:o}}(t.content),{name:r,ext:s}=function(e){const t=e.lastIndexOf(".");return-1===t?{name:e,ext:""}:{name:e.slice(0,t),ext:e.slice(t+1)}}(n.name);return o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement(l.Avatar,{className:a.fileIcon},s.toUpperCase()),o.createElement(l.Box,{display:"flex",flexDirection:"column",className:a.fileBody},r,o.createElement("span",null,s+" "+n.size)))},he=s.makeStyles(e=>({mediaContent:{maxWidth:284,maxHeight:190,backgroundColor:e.palette.secondary.main,borderRadius:e.spacing(1.2),[e.breakpoints.down("sm")]:{maxWidth:250,maxHeight:210}}})),ye=e=>{let{apiUrl:t,message:a,isConference:n}=e;const r=he();let l="";if(n){const e=JSON.parse(a.content);l=Z(t,"/static/conf/"+e.visitId+"/"+e.name)}else l=Z(t,"/static/file/"+a.content);return o.createElement("video",{src:l,className:r.mediaContent,controls:!0,muted:!0,preload:"none"},"Ваш браузер не поддерживает тег video.")},Ce=s.makeStyles(e=>s.createStyles({img:{cursor:"pointer",borderRadius:e.spacing(1.2),maxWidth:284,maxHeight:190,[e.breakpoints.down("sm")]:{maxWidth:250,maxHeight:170}},aspect:{maxWidth:284,maxHeight:190,[e.breakpoints.down("sm")]:{maxWidth:250,maxHeight:170}}})),Te=e=>{let{apiUrl:t,message:a,setViewerData:n}=e;const r=Ce();return o.createElement(b.AspectRatio,{ratio:"3/4",className:r.aspect},o.createElement("img",{src:Z(t,"/static/image/"+a.content),onClick:()=>{n({visible:!0,src:Z(t,"/static/image/"+a.content)})},className:r.img,alt:a.cdate}))},ve=e=>{let{apiUrl:t,message:a,setViewerData:n}=e;switch(a.messageType){case"text":return o.createElement(o.Fragment,null,a.content);case"video":case"video_conference":return o.createElement(ye,{message:a,apiUrl:t,isConference:"video_conference"===a.messageType});case"image":return o.createElement(Te,{message:a,apiUrl:t,setViewerData:n});case"file":return o.createElement(fe,{message:a})}return null};var Re=s.makeStyles(e=>s.createStyles({rootContact:{padding:1,paddingLeft:e.spacing(2),"& span":{float:"right",color:e.palette.text.secondary,fontSize:"0.8rem"},"& $message":{backgroundColor:e.palette.grey[200],color:e.palette.text.primary,borderTopRightRadius:e.spacing(3),borderBottomRightRadius:e.spacing(3)},"& $firstMessage":{borderTopLeftRadius:e.spacing(3),marginTop:10},"& $lastMessage":{borderTopRightRadius:e.spacing(3),borderBottomLeftRadius:0,borderBottomRightRadius:e.spacing(3),marginBottom:10}},rootUser:{padding:1,paddingRight:e.spacing(2),justifyContent:"flex-end","& span":{float:"right",color:"#D9DEEC",fontSize:"0.8rem"},"& $message":{backgroundColor:e.palette.primary.main,color:e.palette.primary.contrastText,borderTopLeftRadius:e.spacing(3),borderBottomLeftRadius:e.spacing(3)},"& $firstMessage":{borderTopRightRadius:e.spacing(3),marginTop:10},"& $lastMessage":{borderTopLeftRadius:e.spacing(3),borderBottomRightRadius:0,marginBottom:10}},rootNotify:{justifyContent:"center","& span":{float:"right",color:e.palette.text.secondary,fontSize:"0.8rem"},"& > *":{borderRadius:e.spacing(3),fontWeight:500}},message:{maxWidth:"65%",[e.breakpoints.down("md")]:{maxWidth:"95%"},[e.breakpoints.down("sm")]:{maxWidth:"85%"},borderRadius:e.spacing(.6),padding:e.spacing(.9),paddingLeft:e.spacing(1.8),paddingRight:e.spacing(1.8)},firstMessage:{},lastMessage:{},file:{display:"flex",flexDirection:"row",flexWrap:"wrap",cursor:"pointer"},header:{flex:"0 0 100%",overflow:"hidden",fontWeight:"bold"},body:{flex:"1 1 auto",wordBreak:"break-word",overflow:"hidden"},status:{paddingLeft:e.spacing(1),flex:"1 1 auto",alignSelf:"flex-end"},statusImage:{fontSize:"1rem",marginRight:e.spacing(.5),verticalAlign:"middle"}}));const Ie=e=>{const t=Re(),{t:a}=m.useTranslation(),{apiUrl:n,message:o,owner:s,user:i,isGroupMessage:c,isUserFirst:u,isUserLast:p,setViewerData:E}=e;if("notify"===o.messageType){const e="{"===o.content[0]?JSON.parse(o.content):o.content;return r.createElement(l.ListItem,{className:t.rootNotify},r.createElement(l.Alert,{severity:"string"==typeof e?"info":e.severity},"string"==typeof e?e:e.message))}if(o.isRevoke)return r.createElement(l.ListItem,{className:t.rootNotify},r.createElement(l.Typography,{variant:"body2",align:"center"},o.userId===i.userId?a("CHAT.MESSAGE.REVOKED.YOU"):o.revokeUserName+" "+a("CHAT.MESSAGE.REVOKED.CONTACT")));const g=i.userId===o.userId;return r.createElement(l.ListItem,{className:"video_conference"===o.messageType?t.rootNotify:g?t.rootUser:t.rootContact},((e,t,a,n,o,s,i)=>{const{messageType:c}=t,u=n&&o?a.message+" "+a.firstMessage+" "+a.lastMessage:n?a.message+" "+a.firstMessage:o?a.message+" "+a.lastMessage:a.message;return"file"===c?r.createElement(l.Link,{className:u+" "+a.file,underline:"none",href:Z(e,"/static/file/"+t.content),target:"_blank",download:!0,onContextMenu:s},i):r.createElement(l.Box,{display:"flex",flexDirection:"image"===c||"video"===c||"video_conference"===c?"column":"row",flexWrap:"wrap",className:u,onContextMenu:s},i)})(n,o,t,u,p,e.onContextMenu,r.createElement(r.Fragment,null,!g&&c&&s&&u&&r.createElement("div",{className:t.header},s.username),r.createElement("div",{className:t.body},r.createElement(ve,{message:o,apiUrl:n,setViewerData:E})),r.createElement("div",{className:t.status},r.createElement("span",null,g?r.createElement(0===o.status?d.Done:d.DoneAll,{className:t.statusImage}):null,W(o.cdate))))))},Se={userId:0,username:"",password:"",avatar:"",langCode:""},Ae={user:Se,token:"",refreshToken:"",activeRoom:null,chatOld:null,groupGather:{},userGather:{},contactGather:{},operators:[],initialContactId:null,conference:{data:null,joined:!1,ringPlayed:!1},typing:null,loading:!1,error:void 0,success:void 0,visitData:[]},Oe=e=>e.activeRoom?e.groupGather[e.activeRoom.groupId]||e.contactGather[e.activeRoom.userId]:null,Ne=e=>{const{activeRoom:t,initialContactId:a,contactGather:n}=e;let r=null;if(a)r=n[a];else if(t)r=Oe(e);else{const t=[...Object.values(e.contactGather),...Object.values(e.groupGather)].sort(X);t.length>0&&(r=t[0])}return r},xe=(e,t,a)=>{const n={...e};e.contactGather[t]&&(n.contactGather[t]={...n.contactGather[t],online:a});for(const n of Object.values(e.groupGather)){if(!n.members)continue;const e=n.members.find(e=>e.userId===t);if(e){const t=n.members.indexOf(e);n.members[t]={...e,online:a}}}const r=n.operators.findIndex(e=>e.userId===t);return-1!==r&&(n.operators[r]={...n.operators[r],online:a}),n.activeRoom=Oe(n),n},_e=(e,t,a)=>{const n={...e};return n.contactGather[t]&&(n.contactGather[t]={...n.contactGather[t],unreadCount:a(n.contactGather[t].unreadCount)}),n.activeRoom=Oe(n),n},be=(e,t,a)=>{const n={...e};return n.groupGather[t]&&(n.groupGather[t]={...n.groupGather[t],unreadCount:a(n.groupGather[t].unreadCount)}),n.activeRoom=Oe(n),n};function Ge(e,t){switch(t.type){case"SET_GROUP_GATHER":return{...e,groupGather:{...e.groupGather,[t.payload.groupId]:t.payload}};case"SET_CONTACT_GATHER":return{...e,contactGather:{...e.contactGather,[t.payload.userId]:t.payload}};case"DEL_GROUP":return((e,t)=>{const a={...e},n=a.activeRoom===a.groupGather[t];return delete a.groupGather[t],n&&(a.activeRoom=Ne(a)),a})(e,t.payload);case"DEL_GROUP_MEMBER":return((e,t)=>{const a={...e},n=a.groupGather[t.groupId];var r;return n&&(n.members=null==(r=n.members)?void 0:r.filter(e=>e.userId!==t.userId)),a})(e,t.payload);case"DEL_CONTACT":return((e,t)=>{const a={...e},n=a.activeRoom===a.contactGather[t];return delete a.contactGather[t],n&&(a.activeRoom=Ne(a)),a})(e,t.payload.userId);case"SET_USER_GATHER":return{...e,userGather:{...e.userGather,[t.payload.userId]:t.payload}};case"UPDATE_ACTIVE_ROOM":return{...e,activeRoom:Ne(e)};case"SET_ACTIVE_ROOM":return((e,t)=>({...e,chatOld:null!=e.activeRoom?{...e.activeRoom}:null,activeRoom:t.groupId?e.groupGather[t.groupId]:t.contactId?e.contactGather[t.contactId]:null}))(e,t.payload);case"USER_ONLINE":return xe(e,t.payload,1);case"USER_OFFLINE":return xe(e,t.payload,0);case"ADD_GROUP_MESSAGE":return((e,t)=>{const a={...e},{groupId:n}=t;a.groupGather[n]&&(a.groupGather[n].messages?a.groupGather[n].messages=[...a.groupGather[n].messages,t]:a.groupGather[n]={...e.groupGather[n],messages:[t]});const{activeRoom:r}=a;return r&&r.groupId!==n&&t.userId!==e.user.userId?be(a,n,e=>(e||0)+1):(a.activeRoom=Oe(a),a)})(e,t.payload);case"ADD_PRIVATE_MESSAGE":return((e,t)=>{var a;const n={...e},r=t.contactId===e.user.userId?t.userId:t.contactId;return n.contactGather[r].messages?n.contactGather[r].messages=[...n.contactGather[r].messages,t]:n.contactGather[r]={...n.contactGather[r],messages:[t]},(null==(a=n.activeRoom)?void 0:a.userId)!==r&&t.userId!==e.user.userId?_e(n,r,e=>(e||0)+1):(n.activeRoom=Oe(n),n)})(e,t.payload);case"ADD_GROUP_UNREAD_GATHER":return be(e,t.payload,e=>(e||0)+1);case"ADD_CONTACT_UNREAD_GATHER":return _e(e,t.payload,e=>(e||0)+1);case"SET_TYPING":return{...e,typing:t.payload};case"LOSE_GROUP_UNREAD_GATHER":return be(e,t.payload,()=>0);case"LOSE_CONTACT_UNREAD_GATHER":return _e(e,t.payload,()=>0);case"REVOKE_MESSAGE":return((e,t)=>{const{userId:a}=e.user,n={...e},r=t.username||n.userGather[t.userId].username;if(t.groupId){const{messages:e}=n.groupGather[t.groupId];if(e){const a=e.find(e=>e._id===t._id);if(a){const t=e.indexOf(a);e[t]={...a,isRevoke:!0,revokeUserName:r}}}}else{const{messages:e}=n.contactGather[t.contactId===a?t.userId:t.contactId];if(e){const a=e.find(e=>e._id===t._id);if(a){const t=e.indexOf(a);e[t]={...a,isRevoke:!0,revokeUserName:r}}}}return n.activeRoom=Oe(n),n})(e,t.payload);case"UPDATE_GROUP_INFO":return((e,t)=>{const a={...e},{groupId:n,name:r,notice:o}=t,l=a.groupGather[n];return l&&(a.groupGather[n]={...l,name:r,notice:o}),a.activeRoom=Oe(a),a})(e,t.payload);case"UPDATE_USER_INFO":return((e,t)=>{const a={...e},{userId:n,username:r,avatar:o}=t;return a.userGather[n]&&(a.userGather[n]={...a.userGather[n],username:r,avatar:o}),a.contactGather[n]&&(a.contactGather[n]={...a.contactGather[n],username:r,avatar:o}),a.activeRoom=Oe(a),a})(e,t.payload);case"ADD_GROUP_MEMBER":return((e,t)=>{const a=t.members.map(e=>({...e,isManager:0})),n={...e};return n.groupGather[t.groupId].members&&a?n.groupGather[t.groupId].members=[...e.groupGather[t.groupId].members,...a]:n.groupGather[t.groupId]={...n.groupGather[t.groupId],members:a},n.activeRoom=Oe(n),n})(e,t.payload);case"SET_CONFERENCE":return((e,t)=>({...e,conference:{data:{...t},joined:(null==t?void 0:t.userId)===e.user.userId,ringPlayed:(null==t?void 0:t.userId)!==e.user.userId}}))(e,t.payload);case"JOIN_CONFERENCE":return{...e,conference:{data:{...t.payload},joined:!0,ringPlayed:!1}};case"PAUSE_CONFERENCE":return((e,t)=>{var a;return(null==(a=e.conference.data)?void 0:a.id)!==(null==t?void 0:t.id)?e:{...e,conference:{data:{...e.conference.data},joined:!1,ringPlayed:!1}}})(e,t.payload);case"STOP_CONFERENCE":return((e,t)=>{var a;return(null==(a=e.conference.data)?void 0:a.id)!==(null==t?void 0:t.id)?e:{...e,conference:{data:null,joined:!1,ringPlayed:!1}}})(e,t.payload);case"MARK_PRIVATE_MESSAGES_READ":return((e,t)=>{const a={...e};if(a.contactGather[t]){const e={...a.contactGather[t]};if(e.messages)for(let t=0;t<e.messages.length;t++)e.messages[t]={...e.messages[t],status:1};a.contactGather[t]=e}if(a.activeRoom=Oe(a),null!=a.activeRoom&&a.activeRoom.messages)for(let e=0;e<a.activeRoom.messages.length;e++)a.activeRoom.messages[e]={...a.activeRoom.messages[e],status:1};return a})(e,t.payload);case"ADD_PRIVATE_MESSAGES":return((e,t)=>{const a={...e},{messages:n,contactId:r}=t;return a.contactGather[r]&&(a.contactGather[r]={...a.contactGather[r],messages:[...n||[],...a.contactGather[r].messages||[]],noMoreData:!(null==n||!n.length)&&(null==n?void 0:n.length)<t.pageSize}),a.activeRoom=Oe(a),a})(e,t.payload);case"ADD_GROUP_MESSAGES":return((e,t)=>{const a={...e},{groupId:n,messages:r,userArr:o}=t;a.groupGather[n]&&(a.groupGather[n]={...a.groupGather[n],messages:[...r||[],...a.groupGather[n].messages||[]],noMoreData:!(null==r||!r.length)&&(null==r?void 0:r.length)<t.pageSize}),a.userGather={...a.userGather};for(const e of o)a.userGather[e.userId]||(a.userGather[e.userId]=e);return a.activeRoom=Oe(a),a})(e,t.payload);case"SET_LOADING":return{...e,loading:t.payload,error:""};case"SET_ERROR":return{...e,error:t.payload,success:void 0};case"SET_SUCCES":return{...e,success:t.payload,error:void 0};case"SET_TOKEN":return((e,t)=>({...e,token:t}))(e,t.payload);case"SET_USER":return{...e,user:t.payload};case"CLEAR_USER":return(e=>({...e,token:"",user:Se}))(e);case"CLEAR_CHAT_DATA":return{...e,activeRoom:null,groupGather:{},userGather:{},contactGather:{},conference:{data:null,joined:!1,ringPlayed:!1},typing:null};case"SET_OPERATORS":return{...e,operators:t.payload};case"SET_VISIT_DATA":return{...e,visitData:t.payload}}return e}const ke=o.createContext({state:Ae,dispatch:()=>null}),De=e=>{Se.langCode=e.defLang;const t=e.token,a=e.token,n={...Ae,token:t,refreshToken:a},[r,l]=o.useReducer(Ge,n);return o.createElement(ke.Provider,{value:{state:r,dispatch:l}},e.children)},Me=s.makeStyles(e=>s.createStyles({messageListOuter:{flex:1,overflowY:"auto",margin:0,padding:0},messageList:{height:"100%",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:e.palette.primary.light+" #fff"},img:{cursor:"pointer",borderRadius:e.spacing(1.2),maxWidth:"auto",maxHeight:"95%",[e.breakpoints.down("sm")]:{maxWidth:"auto",maxHeight:"95%"}},arrowDown:{position:"absolute",left:"94.5%",bottom:105,[e.breakpoints.down("md")]:{left:"91.5%",bottom:95},[e.breakpoints.down("sm")]:{left:"84%",bottom:95}}})),we=e=>{let{loading:t}=e;return t&&o.createElement(l.Box,{sx:{width:"100%",mx:"auto",textAlign:"center"}},o.createElement(l.CircularProgress,null))},Ue=e=>{const{apiUrl:t,user:a,users:n,chat:r,loading:s,pageSize:i,setMenuState:c,initialMenuState:u}=e,d=Me(),{dispatch:m}=o.useContext(ke),[p,E]=o.useState(!1),g=null==r?void 0:r.messages,f=(null==g?void 0:g.length)||0,[h,y]=o.useState(564),C=g&&g.filter(e=>null!=(null==e?void 0:e.status)&&0===e.status),T=o.useRef(null),[v,R]=o.useState({visible:!1,src:""});o.useEffect(()=>{setTimeout(()=>{T.current&&(m({type:"MARK_PRIVATE_MESSAGES_READ",payload:a.userId}),T.current.scrollTop=T.current.scrollHeight)},1e3)},[]),o.useEffect(()=>{I()},[J(r)]);const I=()=>{T.current&&(m({type:"MARK_PRIVATE_MESSAGES_READ",payload:a.userId}),T.current.scrollTop=T.current.scrollHeight,y(T.current.scrollHeight-T.current.scrollTop))};return o.createElement(l.CardContent,{className:d.messageListOuter},o.createElement(l.List,{className:d.messageList,ref:T},o.createElement(G,{pageStart:0,loadMore:()=>{f>=i&&!s&&e.onNeedMoreMessages&&r&&e.onNeedMoreMessages(r)},hasMore:!(!r||r.noMoreData),loader:o.createElement(we,{loading:s,key:0}),isReverse:!0,useCapture:!0,useWindow:!1,getScrollParent:()=>{if(T.current){const e=T.current.scrollHeight-T.current.scrollTop;E(T.current.scrollTop<T.current.scrollHeight-h),e>h&&e<h+90&&I()}return T.current}},g&&g.map((l,s)=>o.createElement(Ie,{key:s,apiUrl:t,user:a,message:l,owner:n[l.userId],isGroupMessage:!(null==r||!r.groupId),isUserFirst:0===s||"notify"===g[s-1].messageType||g[s-1].userId!==g[s].userId,isUserLast:s===g.length-1||"notify"===g[s+1].messageType||g[s+1].userId!==g[s].userId,onContextMenu:t=>((t,n)=>{const r="text"===t.messageType,o=a.userId===t.userId&&!!e.onMeesageDelete&&(new Date).getTime()-new Date(t.cdate).getTime()<=12e4;r||o?(n.preventDefault(),c({message:t,mouseX:n.clientX-2,mouseY:n.clientY-4,canCopy:r,canDelete:o})):c(u)})(l,t),setViewerData:R})))),p&&o.createElement(l.Box,{className:d.arrowDown,textAlign:"center"},o.createElement(l.Fab,{color:"info","aria-label":"add",size:"medium",onClick:I},o.createElement(A,null)),null!=C&&C.length>0&&o.createElement(l.Fab,{color:"warning","aria-label":"add",size:"small",sx:{width:24,height:24,minHeight:24,position:"relative",top:-10,pointerEvents:"none"}},o.createElement(l.Typography,{variant:"body2",sx:e=>({color:e.palette.background.default})},C.length))),v.visible&&o.createElement(l.Backdrop,{sx:{color:"#fff",zIndex:e=>e.zIndex.drawer+1},open:v.visible,onClick:()=>{R({visible:!1,src:""})}},o.createElement("img",{src:v.src,className:d.img,alt:""})))},Le=s.makeStyles(e=>s.createStyles({root:{width:"100%",minWidth:360,height:"100%",display:"flex",flexDirection:"column"},roomHeader:{flex:1},flexAll:{flex:"1 1 auto"},flexEnd:{justifyContent:"flex-end"}})),Pe={message:null,mouseX:null,mouseY:null,canCopy:!1,canDelete:!1},je=e=>{const{apiUrl:t,user:a,users:n,chat:s,typing:d,conference:p,visitData:E,conferenceJoined:g,loading:f,pageSize:h}=e,y=Le(),{t:C}=m.useTranslation(),T=l.useMediaQuery(e=>e.breakpoints.down("sm")),[v,R]=o.useState(Pe),I=r.useCallback(()=>{const{message:e}=v;R(Pe),e&&navigator.clipboard.writeText(e.content)},[v.message]),S=r.useCallback(()=>{const{message:t}=v;R(Pe),e.onMeesageDelete&&s&&t&&e.onMeesageDelete(s,t)},[v.message]);return o.createElement(l.Card,{elevation:1,className:y.root},o.createElement(l.Box,{display:"flex",flexDirection:"row"},s&&T&&o.createElement(l.Tooltip,{title:"Вернуться в конференцию"},o.createElement(l.IconButton,{"aria-label":"exit room",onClick:()=>e.onExitRoom&&e.onExitRoom(s)},o.createElement(u,null))),o.createElement(Ee,{apiUrl:t,user:a,chat:s,typing:d,conference:p,visitData:E,conferenceJoined:g,operators:e.operators,className:y.roomHeader,onVideoCall:e.onVideoCall,onVideoEnd:e.onVideoEnd,onConferencePause:e.onConferencePause,onOperatorAdd:e.onOperatorAdd,onLeaveGroup:e.onLeaveGroup})),o.createElement(l.Divider,null),o.createElement(Ue,{apiUrl:t,user:a,users:n,chat:s,loading:f,pageSize:h,initialMenuState:Pe,onNeedMoreMessages:e.onNeedMoreMessages,onMeesageDelete:e.onMeesageDelete,setMenuState:R}),o.createElement(l.Divider,null),o.createElement(l.CardContent,null,o.createElement(Y,{chat:s,onTyping:e.onTyping,onSendMessage:e.onSendMessage})),o.createElement(l.Menu,{keepMounted:!0,open:null!==v.mouseY,onClose:()=>{R(Pe)},anchorReference:"anchorPosition",anchorPosition:null!==v.mouseY&&null!==v.mouseX?{top:v.mouseY,left:v.mouseX}:void 0},o.createElement(l.MenuItem,{onClick:I,disabled:!v.canCopy},o.createElement("span",{className:y.flexAll},C("CHAT.MESSAGE.MENU.COPY")),o.createElement(l.ListItemIcon,{className:y.flexEnd},o.createElement(i,{fontSize:"small"}))),o.createElement(l.MenuItem,{onClick:S,disabled:!v.canDelete},o.createElement("span",{className:y.flexAll},C("CHAT.MESSAGE.MENU.DELETE")),o.createElement(l.ListItemIcon,{className:y.flexEnd},o.createElement(c,{fontSize:"small"})))))},Fe=s.makeStyles(e=>s.createStyles({main:{flex:"1 1 auto",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},time:{paddingLeft:e.spacing(1),justifyContent:"flex-end",whiteSpace:"nowrap"},unread:{justifyContent:"flex-end",maxHeight:20},avatarGroup:{backgroundColor:"#28B7C6",color:"#fff"}})),He=s.withStyles(e=>s.createStyles({badge:{backgroundColor:"#44b700",color:"#44b700",boxShadow:"0 0 0 2px "+e.palette.background.paper,"&::after":{position:"absolute",top:0,left:0,width:"100%",height:"100%",borderRadius:"50%",animation:"$ripple 1.2s infinite ease-in-out",border:"1px solid currentColor",content:'""'}},"@keyframes ripple":{"0%":{transform:"scale(.8)",opacity:1},"100%":{transform:"scale(2.4)",opacity:0}}}))(l.Badge),Be=s.withStyles(e=>s.createStyles({badge:{backgroundColor:e.palette.primary.main,boxShadow:"0 0 0 2px "+e.palette.background.paper}}))(l.Badge),ze=e=>{const t=Fe(),{t:a}=m.useTranslation(),{apiUrl:n,chat:s,typing:i}=e,c=$(s),u=s.groupId?o.createElement(l.Avatar,{alt:c,className:t.avatarGroup},o.createElement(p,null)," "):((e,t,a)=>{const n=o.createElement(l.Avatar,{alt:t.username,src:t.avatar?Z(e,t.avatar):""});return null!=a&&a.contactId&&(null==a?void 0:a.userId)===t.userId?o.createElement(He,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},variant:"dot"},n):null!=t&&t.online?o.createElement(Be,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},variant:"dot"},n):n})(n,s,i),d=s.messages&&s.messages.length>0?s.messages[s.messages.length-1]:null,E=((e,t)=>{if(!e)return null;switch(e.messageType){case"text":return e.content;case"image":return"["+t("CHAT.MESSAGE.TYPE.IMAGE")+"]";case"video":return"["+t("CHAT.MESSAGE.TYPE.VIDEO")+"]";case"file":return"["+t("CHAT.MESSAGE.TYPE.FILE")+"]";case"notify":return"["+t("CHAT.MESSAGE.TYPE.NOTIFY")+"]";default:return null}})(d,a),g=null==d?void 0:d.cdate;return r.useMemo(()=>o.createElement(l.ListItem,{button:!0,selected:e.active,onClick:e.onClick},o.createElement(l.ListItemAvatar,null,u),o.createElement(l.ListItemText,{secondaryTypographyProps:{component:"span"},primary:o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement("span",{className:t.main},c),o.createElement("span",{className:t.time},W(g))),secondary:o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement("span",{className:t.main},E),s.unreadCount?o.createElement(l.Chip,{className:t.unread,component:"span",size:"small",color:"primary",label:s.unreadCount}):null)})),[g])},Ve=s.makeStyles(e=>({root:{width:"100%",height:"100%"},searchField:{width:"100%"},listStyle:{height:"89.5%",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:e.palette.primary.light+" #fff"}})),Ye=(e,t)=>{if(null===t)return e;const a=t.toLowerCase();return e.filter(e=>-1!==$(e).toLowerCase().indexOf(a.toLowerCase()))},qe=(e,t,a)=>{let n=[...t,...a];n=n.sort(X);const r=localStorage.getItem(e+"-topChatId");if(r){const e=n.find(e=>J(e)===r);e&&(n=n.filter(e=>J(e)!==r),e.isTop=!0,n.unshift(e))}return n},Ke=e=>{const t=Ve(),{t:a}=m.useTranslation(),[n,r]=o.useState(qe(e.user.userId,Ye(e.groups,null),Ye(e.contacts,null))),s=o.useMemo(()=>n.map(t=>o.createElement(ze,{key:J(t),apiUrl:e.apiUrl,chat:t,active:t===e.activeRoom,typing:e.typing,onClick:()=>null!=e.onChangeChat&&e.onChangeChat(t)})),[e.activeRoom,e.typing]);return o.createElement(l.Card,{elevation:1,className:t.root},o.createElement(l.CardHeader,{title:o.createElement(l.TextField,{className:t.searchField,label:a("CHAT.INPUT_SEARCH_CONTACT"),variant:"outlined",size:"small",fullWidth:!0,onChange:t=>{r(qe(e.user.userId,Ye(e.groups,t.target.value),Ye(e.contacts,t.target.value)))}})}),o.createElement(l.Divider,null),o.createElement(k,{"aria-label":"rooms",className:t.listStyle},s))},We=s.makeStyles(()=>({root:{width:"100%",height:"100%",borderRadius:4}})),Je=e=>{let{conference:t,onClose:a,langCode:n="en"}=e;const l=We(),s=o.useRef(null),i=null!=t&&t.url&&n?function(e,t,a){const n=new RegExp("(lang=)[^&]+");return e.replace(n,"$1"+a)}(null==t?void 0:t.url,0,(e=>"ru"===e?"rus":"fr"===e?"fra":"en"===e?"eng":"")(n)):"";return r.useEffect(()=>{const e=e=>{var n;let{source:r,data:o}=e;if(r===(null==(n=s.current)?void 0:n.contentWindow)){const{type:e}=o;["notSupported","connectionFail","callFail","hangUp","remoteHangUp"].includes(e)&&a(t)}};return window.addEventListener("message",e),()=>{window.removeEventListener("message",e)}},[null==t?void 0:t.id,n]),o.createElement("iframe",{title:"conference",className:l.root,src:i,allowFullScreen:!0,allow:"microphone; camera; autoplay; display-capture",ref:s})},$e=s.makeStyles(()=>({root:{width:"100%",height:"100%",borderRadius:8,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"},pulse:{height:100,width:100,borderRadius:"50%",display:"flex",justifyContent:"center",alignItems:"center",position:"relative","&::before":{content:"''",position:"absolute",border:"1px solid green",width:"calc(100% + 40px)",height:"calc(100% + 40px)",borderRadius:"50%",animation:"$pulse 1s linear infinite"},"&::after":{content:"''",position:"absolute",border:"1px solid green",width:"calc(100% + 40px)",height:"calc(100% + 40px)",borderRadius:"50%",animation:"$pulse 1s linear infinite",animationDelay:"0.3s"}},avatar:{width:"80%",height:"80%"},footer:{width:"100%",alignSelf:"flex-end",paddingTop:64,display:"flex",justifyContent:"center"},"@keyframes pulse":{"0%":{transform:"scale(0.5)",opacity:0},"50%":{transform:"scale(1)",opacity:1},"100%":{transform:"scale(1.3)",opacity:0}}})),Xe=e=>{let{conference:t,contact:a,apiUrl:n,onAccept:r}=e;const s=$e(),{t:i}=m.useTranslation();return o.createElement(l.Paper,{className:s.root},o.createElement("div",{className:s.pulse},o.createElement(l.Avatar,a?{className:s.avatar,alt:a.username,src:a.avatar?Z(n,a.avatar):""}:{className:s.avatar})),o.createElement("div",{className:s.footer},o.createElement(l.Button,{variant:"contained",color:"primary",onClick:()=>r(t)},i("CHAT.CONFERENCE.JOIN"))))},Qe=r.createContext({});function Ze(){localStorage.removeItem("authToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),localStorage.removeItem("doctor"),localStorage.removeItem("chatUser")}const et=async()=>{try{await D.post("auth/logout")}catch(e){console.log("ERROR Logout",e)}Ze(),window.location.href="/"},tt=async(e,t,a)=>{try{const{data:a}=await D.post("auth/refreshToken",{authToken:e,refreshToken:t});localStorage.setItem("authToken",null==a?void 0:a.authToken),localStorage.setItem("refreshToken",null==a?void 0:a.refreshToken),window.location.href="/"}catch(e){console.log("ERROR RefreshToken",e),a({type:"CLEAR_USER"}),et()}},at=e=>{let{baseURLApi:t,pageSize:a,children:n}=e;const{state:l,dispatch:s}=r.useContext(ke),i=D.create({timeout:6e4,baseURL:t,headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Authorization:"Bearer "+l.token},withCredentials:!1});i.interceptors.response.use(e=>e,e=>(console.log("ERROR AxiosError"),(e=>{null!=e.response&&401===e.response.status&&tt(l.token,l.refreshToken,s)})(e),Promise.reject(e)));const c=r.useCallback(async(e,t)=>{var n;const r=e.userId,o=null==(n=e.messages)?void 0:n.length;try{s({type:"SET_LOADING",payload:!0});const{data:e}=await i.get("/contact/messages",{params:{contactId:r,current:o,pageSize:a}});e&&(s({type:"ADD_PRIVATE_MESSAGES",payload:{pageSize:a,contactId:r,messages:e}}),t&&t())}catch(e){s({type:"SET_ERROR",payload:e.message})}finally{s({type:"SET_LOADING",payload:!1})}},[s]),u=r.useCallback(async e=>{var t;const{groupId:n}=e,r=null==(t=e.messages)?void 0:t.length;try{s({type:"SET_LOADING",payload:!0});const{data:e}=await i.get("/group/messages",{params:{groupId:n,current:r,pageSize:a}});e&&s({type:"ADD_GROUP_MESSAGES",payload:{pageSize:a,groupId:n,...e}})}catch(e){s({type:"SET_ERROR",payload:e.message})}finally{s({type:"SET_LOADING",payload:!1})}},[s]);return o.createElement(Qe.Provider,{value:{apiUrl:t,pageSize:a,fetch:i,getPrivateMessages:c,getGroupMessages:u,getUserByMmk:async(e,t)=>{try{const{data:a}=await i.get("/contact/find",{params:{mmkId:e,guid:t}});if(null!=a)return a}catch(e){console.log("err getUserByMmk",e)}}}},n)},nt=r.createContext({online:!1}),rt=e=>{let{wsUrl:t,wsPath:a,children:n}=e;const{state:l,dispatch:s}=r.useContext(ke),{socket:i,online:c,disconnectSocket:u,connectSocket:d}=((e,t,a)=>{const[n,o]=r.useState(null),l=r.useCallback(()=>{const n=M(e,{path:t,reconnection:!0,extraHeaders:{Authorization:"Bearer "+a}});o(n)},[e,t,a]),s=r.useCallback(()=>{null==n||n.disconnect(),o(null)},[n]),[i,c]=r.useState(!1);return r.useEffect(()=>{c(!(null==n||!n.connected))},[n]),r.useEffect(()=>{null==n||n.on("connect",()=>{c(!0),n.emit("chatData")})},[n]),r.useEffect(()=>{null==n||n.on("disconnect",()=>{c(!1)})},[n]),{socket:n,online:i,disconnectSocket:s,connectSocket:l}})(t,a,l.token);return r.useEffect(()=>(l.token&&d(),()=>{u()}),[l.token,d]),r.useEffect(()=>{l.token||u()},[l.token,u]),r.useEffect(()=>{const e=e=>{console.log("unauthorized msg",e),tt(l.token,l.refreshToken,s)};return null==i||i.on("unauthorized",e),()=>{null==i||i.off("unauthorized",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{if(e.code)return void s({type:"SET_ERROR",payload:e.msg});console.log("res.data",e.data);const t=e.data,a=t.groupData,n=t.contactData,r=t.userData;if(s({type:"CLEAR_CHAT_DATA"}),s({type:"SET_USER",payload:t.user}),a.length)for(const e of a)null==i||i.emit("joinGroupSocket",{groupId:e.groupId}),s({type:"SET_GROUP_GATHER",payload:e});if(n.length)for(const e of n)null==i||i.emit("joinPrivateSocket",{contactId:e.userId}),s({type:"SET_CONTACT_GATHER",payload:e});if(s({type:"SET_OPERATORS",payload:t.operatorData}),r.length)for(const e of r)s({type:"SET_USER_GATHER",payload:e});s({type:"UPDATE_ACTIVE_ROOM"}),s({type:"SET_CONFERENCE",payload:t.conferenceData}),s({type:"SET_VISIT_DATA",payload:t.visitData})};return null==i||i.on("chatData",e),()=>{null==i||i.off("chatData",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s({type:"USER_ONLINE",payload:e.data})};return null==i||i.on("userOnline",e),()=>{null==i||i.off("userOnline",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s({type:"USER_OFFLINE",payload:e.data})};return null==i||i.on("userOffline",e),()=>{null==i||i.off("userOffline",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{e.code?s({type:"SET_ERROR",payload:e.msg}):console.log("Успешно вошел в приватный чат")};return null==i||i.on("joinPrivateSocket",e),()=>{null==i||i.off("joinPrivateSocket",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{var t;if(e.code)return void s({type:"SET_ERROR",payload:e.msg});const a=e.data,n=a.user;n.online=1;const{group:r}=a,o=l.groupGather[r.groupId];var i;!o||null!=(t=o.members)&&t.find(e=>e.userId===n.userId)||(n.isManager=0,null==(i=o.members)||i.push(n)),s({type:"SET_USER_GATHER",payload:n})};return null==i||i.on("joinGroupSocket",e),()=>{null==i||i.off("joinGroupSocket",e)}},[null==i?void 0:i.id,l.groupGather]),r.useEffect(()=>{const e=async e=>{if(e.code)return void s({type:"SET_ERROR",payload:e.msg});const t=e.data;s({type:"ADD_GROUP_MESSAGE",payload:t});const{activeRoom:a}=l;a&&a.groupId===t.groupId&&t.userId!==l.user.userId&&(null==i||i.emit("markAsRead",{groupId:t.groupId,_id:t._id}))};return null==i||i.on("groupMessage",e),()=>{null==i||i.off("groupMessage",e)}},[null==i?void 0:i.id,l.activeRoom]),r.useEffect(()=>{const e=async e=>{if(e.code)return void s({type:"SET_ERROR",payload:e.msg});const t=e.data;var a;t.contactId!==l.user.userId&&t.userId!==l.user.userId||(s({type:"ADD_PRIVATE_MESSAGE",payload:t}),l.activeRoom&&!l.activeRoom.groupId&&(null==(a=l.activeRoom)?void 0:a.userId)===t.userId&&(null==i||i.emit("markAsRead",{contactId:t.userId,_id:t._id})))};return null==i||i.on("privateMessage",e),()=>{null==i||i.off("privateMessage",e)}},[null==i?void 0:i.id,l.activeRoom]),r.useEffect(()=>{let e;const t=t=>{t.code?s({type:"SET_ERROR",payload:t.msg}):(e&&clearTimeout(e),s({type:"SET_TYPING",payload:t.data}),e=setTimeout(()=>{s({type:"SET_TYPING",payload:null})},1e3))};return null==i||i.on("typing",t),()=>{e&&clearTimeout(e),null==i||i.off("typing",t)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{if(e.code)return void s({type:"SET_ERROR",payload:e.msg});const t=e.data;t.userId===l.user.userId?s(t.groupId?{type:"LOSE_GROUP_UNREAD_GATHER",payload:t.groupId}:{type:"LOSE_CONTACT_UNREAD_GATHER",payload:t.contactId}):t.contactId&&s({type:"MARK_PRIVATE_MESSAGES_READ",payload:t.userId})};return null==i||i.on("markAsRead",e),()=>{null==i||i.off("markAsRead",e)}},[null==i?void 0:i.id,l.user.userId]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"REVOKE_MESSAGE",payload:e.data})};return null==i||i.on("revokeMessage",e),()=>{null==i||i.off("revokeMessage",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_GROUP_GATHER",payload:e.data})};return null==i||i.on("addGroup",e),()=>{null==i||i.off("addGroup",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{if(e.code)return void s({type:"SET_ERROR",payload:e.msg});const t=e.data;s({type:"SET_CONTACT_GATHER",payload:t}),s({type:"SET_USER_GATHER",payload:t}),null==i||i.emit("joinPrivateSocket",{contactId:t.userId})};return null==i||i.on("addContact",e),()=>{null==i||i.off("addContact",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{if(e.code)return void s({type:"SET_ERROR",payload:e.msg});const t=e.data;s(t.userId===l.user.userId?{type:"DEL_GROUP",payload:t.groupId}:{type:"DEL_GROUP_MEMBER",payload:t})};return null==i||i.on("deleteGroup",e),()=>{null==i||i.off("deleteGroup",e)}},[null==i?void 0:i.id,l.user]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"DEL_CONTACT",payload:e.data})};return null==i||i.on("deleteContact",e),()=>{null==i||i.off("deleteContact",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"UPDATE_GROUP_INFO",payload:e.data})};return null==i||i.on("updateGroupInfo",e),()=>{null==i||i.off("updateGroupInfo",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"UPDATE_USER_INFO",payload:e.data})};return null==i||i.on("updateUserInfo",e),()=>{null==i||i.off("updateUserInfo",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{if(e.code)return void s({type:"SET_ERROR",payload:e.msg});const{group:t,user:a}=e.data;l.groupGather[t.groupId]?a.userId!==l.user.userId&&s({type:"ADD_GROUP_MEMBER",payload:{groupId:t.groupId,members:[a]}}):(console.log("joined to a new group"),null==i||i.emit("chatData"))};return null==i||i.on("joinGroup",e),()=>{null==i||i.off("joinGroup",e)}},[null==i?void 0:i.id,l.user,l.groupGather]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_CONFERENCE",payload:e.data})};return null==i||i.on("startConference",e),()=>{null==i||i.off("startConference",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"PAUSE_CONFERENCE",payload:e.data})};return null==i||i.on("pauseConference",e),()=>{null==i||i.off("pauseConference",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"STOP_CONFERENCE",payload:e.data})};return null==i||i.on("stopConference",e),()=>{null==i||i.off("stopConference",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{e.code&&s({type:"SET_ERROR",payload:e.msg})};return null==i||i.on("addOperator",e),()=>{null==i||i.off("addOperator",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_ACTIVE_ROOM",payload:e.data})};return null==i||i.on("setActiveRoom",e),()=>{null==i||i.off("setActiveRoom",e)}},[null==i?void 0:i.id]),r.useEffect(()=>{const e=e=>{s(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_VISIT_DATA",payload:e.data.visitData})};return null==i||i.on("visitData",e),()=>{null==i||i.off("visitData",e)}},[null==i?void 0:i.id]),o.createElement(nt.Provider,{value:{socket:i,online:c}},n)},ot=e=>{let{audio:t,video:a}=e;const{t:n}=m.useTranslation(),{dispatch:r}=o.useContext(ke),s=n(t&&a?"CHAT.CONFERENCE.CheckCamMic":t?"CHAT.CONFERENCE.CheckMic":"CHAT.CONFERENCE.CheckCam");return o.createElement(l.Tooltip,{title:s},o.createElement(l.IconButton,{"aria-label":"check",onClick:()=>{navigator.mediaDevices.getUserMedia({audio:t,video:a}).then(e=>{console.log("permissions",e),r({type:"SET_SUCCES",payload:n("CHAT.CONFERENCE.ALLOK")})}).catch(e=>{let t=n("CHAT.CONFERENCE.ErrorAny");"NotFoundError"===e.name&&(t=n("CHAT.CONFERENCE.NotFoundError")),"NotAllowedError"===e.name&&(t=n("CHAT.CONFERENCE.NotAllowedError")),r({type:"SET_ERROR",payload:t}),console.log("err",e.name+" : "+e.message)})},size:"large"},o.createElement(t&&a?w:t?U:L,null)))},lt=()=>{const{state:{error:e,success:t},dispatch:a}=o.useContext(ke),n=()=>{a({type:"SET_ERROR",payload:void 0}),a({type:"SET_SUCCES",payload:void 0})};return o.createElement(l.Snackbar,{anchorOrigin:{vertical:"top",horizontal:"center"},open:!!e||!!t,autoHideDuration:6e3,onClose:n},o.createElement(l.Alert,{onClose:n,severity:e?"error":"success"},e||t))},st=s.makeStyles(e=>({root:{height:"100%",overflow:"hidden",padding:0,[e.breakpoints.down("sm")]:{width:"100%"}},innerGrid:{height:"100%",width:"100%"},conAbsOnConf:{position:"absolute",top:42,left:25,zIndex:1e3,margin:e.spacing(3)}})),it=e=>{var t,a,n;let{activeGroupId:o,activeChatUserId:s,inModale:i=!0,hideRooms:c=!1}=e;const u=st(),p=l.useMediaQuery(e=>e.breakpoints.down("sm")),{t:E}=m.useTranslation(),{state:g,dispatch:f}=r.useContext(ke),{socket:h}=r.useContext(nt),{apiUrl:y,pageSize:C,getPrivateMessages:T,getGroupMessages:v,getUserByMmk:R}=r.useContext(Qe),I=r.useCallback(()=>{f({type:"SET_ACTIVE_ROOM",payload:{}})},[f]),S=r.useCallback(async e=>{e.groupId?await v(e):await T(e)},[T,v]),A=r.useCallback((e,t)=>{null==h||h.emit("revokeMessage",{groupId:e.groupId,contactId:e.userId,_id:t._id})},[null==h?void 0:h.id]),O=r.useCallback(e=>{null==h||h.emit("typing",{groupId:null==e?void 0:e.groupId,contactId:null==e?void 0:e.userId})},[null==h?void 0:h.id]),N=r.useCallback((e,t)=>{e.groupId?null==h||h.emit("groupMessage",{groupId:null==e?void 0:e.groupId,content:t.message,width:t.width,height:t.height,fileName:t.fileName,messageType:t.messageType,size:t.size}):null==h||h.emit("privateMessage",{contactId:null==e?void 0:e.userId,content:t.message,width:t.width,height:t.height,fileName:t.fileName,messageType:t.messageType,size:t.size})},[null==h?void 0:h.id]),x=r.useCallback(e=>{f({type:"SET_ACTIVE_ROOM",payload:{groupId:null==e?void 0:e.groupId,contactId:null==e?void 0:e.userId}}),_(e)},[null==h?void 0:h.id,f]),_=r.useCallback(e=>{e.messages&&0!==e.messages.length&&(e.groupId?null==h||h.emit("markAsRead",{groupId:e.groupId,_id:e.messages[e.messages.length-1]._id}):null==h||h.emit("markAsRead",{contactId:e.userId,_id:e.messages[e.messages.length-1]._id}))},[null==h?void 0:h.id]),b=r.useCallback((e,t,a)=>{null==h||h.emit("startConference",{groupId:e.groupId,contactId:e.userId,visitId:t,recreate:a})},[null==h?void 0:h.id]),G=r.useCallback(e=>{null!=(null==e?void 0:e.id)&&(null==h||h.emit("stopConference",{id:null==e?void 0:e.id}))},[null==h?void 0:h.id]),k=r.useCallback(e=>{null!=(null==e?void 0:e.id)&&(null==h||h.emit("pauseConference",{id:e.id}))},[null==h?void 0:h.id]),D=r.useCallback(e=>{null!=(null==e?void 0:e.id)&&(null==h||h.emit("resumeConference",{id:e.id})),f({type:"JOIN_CONFERENCE",payload:e})},[null==h?void 0:h.id,f]),M=r.useCallback((e,t)=>{null==h||h.emit("addOperator",{groupId:e.groupId,operatorId:t.userId})},[null==h?void 0:h.id]),w=r.useCallback(e=>{null==h||h.emit("deleteGroup",{groupId:e.groupId})},[null==h?void 0:h.id]);r.useEffect(()=>{if(null!=s&&!K(g.contactGather)){const e=Object.values(g.contactGather).find(e=>e.userId===s);x(e)}const e=Q("mmk"),t=Q("guid");null==e&&null==t||K(g.contactGather)||(async()=>{const a=await R(e,t);if(null!=a){const e=Object.values(g.contactGather).find(e=>e.userId===a);x(e)}})()},[g.contactGather]),r.useEffect(()=>{if(null!=o&&!K(g.groupGather)){const e=Object.values(g.groupGather).find(e=>e.groupId===o);K(e)||x(e)}},[g.groupGather]);const U=null!=g.activeRoom&&r.createElement(je,{apiUrl:y,user:g.user,users:g.userGather,operators:g.operators,chat:g.activeRoom,typing:g.typing,conference:g.conference.data,visitData:g.visitData,conferenceJoined:g.conference.joined,loading:g.loading,pageSize:C,onExitRoom:I,onEnterRoom:_,onNeedMoreMessages:S,onMeesageDelete:A,onTyping:O,onSendMessage:N,onVideoCall:b,onVideoEnd:G,onConferencePause:k,onOperatorAdd:M,onLeaveGroup:w}),L=()=>r.createElement(Ke,{apiUrl:y,user:g.user,activeRoom:g.activeRoom,groups:Object.values(g.groupGather),contacts:Object.values(g.contactGather),typing:g.typing,onChangeChat:x}),P=()=>g.conference.data&&r.createElement(Xe,{apiUrl:y,contact:g.contactGather[g.user.userId===g.conference.data.userId?g.conference.data.contactId:g.conference.data.userId],conference:g.conference.data,onAccept:D}),j=()=>r.createElement(Je,{conference:g.conference.data,onClose:k,langCode:g.user.langCode}),F=()=>{var e;return null!=(null==(e=g.conference.data)?void 0:e.id)?r.createElement(r.Fragment,null,r.createElement(g.conference.joined?j:P,null),r.createElement(l.Box,{className:u.conAbsOnConf},r.createElement(l.Paper,{style:{borderRadius:8}},r.createElement(l.Box,{display:"flex",flexDirection:"row",my:3},(K(g.activeRoom)&&p||!K(g.activeRoom)&&!p)&&r.createElement(r.Fragment,null,r.createElement(ot,{audio:!0,video:!1}),r.createElement(ot,{audio:!1,video:!0})),K(g.activeRoom)&&null!=g.chatOld&&p&&r.createElement(l.Tooltip,{title:E("CHAT.CONFERENCE.BACK")},r.createElement(l.IconButton,{"aria-label":"check",onClick:()=>null!=g.chatOld&&x(g.chatOld),size:"large"},r.createElement(d.ArrowForward,null))))))):r.createElement(L,null)};return r.createElement(l.Container,{maxWidth:"lg",className:u.root,sx:e=>({width:i?"calc(100vw - "+e.spacing(8)+")":"100%"})},p?r.createElement(r.Fragment,null,r.createElement(F,null),U):r.createElement(l.Grid,{container:!0,spacing:1,className:u.innerGrid},(null!=(null==(t=g.conference.data)?void 0:t.id)||!c)&&r.createElement(l.Grid,{item:!0,sm:null!=(null==(a=g.conference.data)?void 0:a.id)?6:4,className:u.innerGrid},r.createElement(F,null)),r.createElement(l.Grid,{item:!0,sm:null!=(null==(n=g.conference.data)?void 0:n.id)?6:c?12:8,className:u.innerGrid},U)),r.createElement(lt,null))},ct=(()=>{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);return null==t?void 0:t.lang}return"ru"})();P.use(j).use(m.initReactI18next).init({resources:{ru:{translations:{CHAT:{STATUS:{ONLINE:"в сети",OFFLINE:"не в сети",TYPING:"печатает"},MESSAGE:{TYPE:{IMAGE:"Изображение",VIDEO:"Видео",FILE:"Файл",NOTIFY:"Уведомление"},MENU:{COPY:"Копировать",DELETE:"Удалить"},REVOKED:{YOU:"Вы удалили сообщение",CONTACT:"удалил(а) сообщение"}},CONFERENCE:{JOIN:"Присоединиться",START:"Начать",RESTART:"Пересоздать конференцию",CONFIRM_RECREATE_CONF:"Вы уверены что хотите пересоздать конференцию?",PAUSE:"Остановить",FINISH:"Завершить",BACK:"Вернуться в чат",NotFoundError:"Запрошенное устройство не найдено",NotAllowedError:"В доступе  отказано. Чтобы разрешить доступ к устройству зайдите в настройки браузера",ErrorAny:"Устройство не настроено",ALLOK:"Все OK",CheckCamMic:"Проверить доступ к микрофону и камере",CheckMic:"Проверить доступ к микрофону",CheckCam:"Проверить доступ к камере",UntillTheEnd:"До окончания конференции осталось",LEFT_TIME:"Осталось"},ADD_CONTACT:"Добавить контакт",INPUT_MESSAGE:"Напишите сообщение...",INPUT_SEARCH_CONTACT:"Фамилия Имя Отчество",MEMBERS:"участников",BUT_CLOSE:"Закрыть",BUT_CONFIRM:"Да"}}},en:{translations:{CHAT:{STATUS:{ONLINE:"online",OFFLINE:"offline",TYPING:"typing"},MESSAGE:{TYPE:{IMAGE:"Image",VIDEO:"Video",FILE:"File",NOTIFY:"Notification"},MENU:{COPY:"Copy",DELETE:"Delete"},REVOKED:{YOU:"You deleted the message",CONTACT:"deleted the message"}},CONFERENCE:{JOIN:"Join",START:"Start",RESTART:"Recreate the conference",CONFIRM_RECREATE_CONF:"Are you sure you want to re-create the conference?",PAUSE:"Pause",FINISH:"Finish",BACK:"Back to chat",NotFoundError:"Requested device not found",NotAllowedError:"Permission denied. To allow access to the device, go to the browser settings",ErrorAny:"The device is not configured",ALLOK:"All OK",CheckCamMic:"Check access to microphone and camera",CheckMic:"Check access to microphone",CheckCam:"Check access to camera",UntillTheEnd:"There is still time until the end of the conference",LEFT_TIME:"Time left"},ADD_CONTACT:"Add contact",INPUT_MESSAGE:"Please write a message...",INPUT_SEARCH_CONTACT:"Surname Name",MEMBERS:"members",BUT_CLOSE:"Close",BUT_CONFIRM:"Yes"}}},fr:{translations:{CHAT:{STATUS:{ONLINE:"en ligne",OFFLINE:"hors ligne",TYPING:"imprime"},MESSAGE:{TYPE:{IMAGE:"Image",VIDEO:"Vidéo",FILE:"File",NOTIFY:"Notification"},MENU:{COPY:"Copier",DELETE:"Supprimer"},REVOKED:{YOU:"Vous avez supprimé le message",CONTACT:"message supprimé"}},CONFERENCE:{JOIN:"Rejoindre",START:"Démarrer",RESTART:"Recréer la conférence",CONFIRM_RECREATE_CONF:"êtes-vous sûr de vouloir recréer la conférence?",PAUSE:"Pause",FINISH:"Terminer",BACK:"Retour au chat",NotFoundError:"Périphérique demandé introuvable",NotAllowedError:"Autorisation refusée. Pour autoriser l'accès à l'appareil, accédez aux paramètres du navigateur",ErrorAny:"L'appareil n'est pas configuré",ALLOK:"Tout va bien",CheckCamMic:"Vérifier l'accès au microphone et à la caméra",CheckMic:"Vérifier l'accès au microphone",CheckCam:"Vérifier l'accès à la caméra",UntillTheEnd:" Il est encore temps jusqu'à la fin de la conférence",LEFT_TIME:"temps restant:"},ADD_CONTACT:"Ajouter un contact",INPUT_MESSAGE:"Veuillez écrire un message...",INPUT_SEARCH_CONTACT:"Surname Name",MEMBERS:"members",BUT_CLOSE:"Fermer",BUT_CONFIRM:"Oui"}}}},lng:ct,load:"languageOnly",fallbackLng:ct,debug:!0,ns:["translations"],defaultNS:"translations",lowerCaseLng:!0});const ut=(e,t)=>{switch(t.type){case"SET_ENGLISH":return P.changeLanguage("en"),{language:"en"};case"SET_FRENCH":return P.changeLanguage("fr"),{language:"fr"};case"SET_RUSSIAN":return P.changeLanguage("ru"),{language:"ru"};default:return e}},dt=r.createContext({}),mt=e=>{const[t,a]=r.useReducer(ut,{language:P.language.substring(0,2)});return o.createElement(dt.Provider,{value:{languageState:t,dispatchLanguage:a}},o.createElement(m.I18nextProvider,{i18n:P},e.children))};exports.AddContact=ae,exports.ChatContext=ke,exports.ChatIndex=e=>{let{activeGroupId:t,activeChatUserId:a,hideRooms:n=!1,lang:r,chatBaseURLApi:l,chatWsUrl:s,chatWsPath:i,token:c,inModale:u=!1,refreshToken:d}=e;return o.createElement(mt,null,o.createElement(De,{defLang:r,token:c,refreshToken:d},o.createElement(at,{baseURLApi:l,pageSize:25},o.createElement(rt,{wsUrl:s,wsPath:i},o.createElement(it,{activeGroupId:t,activeChatUserId:a,hideRooms:n,inModale:u})))))},exports.ChatPage=it,exports.ChatProvider=De,exports.Conference=Je,exports.ConferenceCall=Xe,exports.Emoji=H,exports.Message=Ie,exports.RestContext=Qe,exports.RestProvider=at,exports.Room=je,exports.RoomList=Ke,exports.SocketContext=nt,exports.SocketProvider=rt,exports.Typing=z,exports.clearLocalStorage=Ze,exports.getRefreshToken=tt,exports.signOut=et;
//# sourceMappingURL=chat.cjs.production.min.js.map
