"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t,a,n,r=require("react"),o=e(r),l=require("@mui/material"),s=require("@mui/styles"),i=e(require("@mui/icons-material/FileCopy")),c=e(require("@mui/icons-material/Delete")),u=e(require("@mui/icons-material/ArrowBack")),d=require("@mui/icons-material"),m=require("react-i18next"),p=e(require("@mui/icons-material/Group")),E=e(require("@mui/icons-material/CallEnd")),g=e(require("@mui/icons-material/PersonAdd")),f=e(require("@mui/icons-material/Star")),h=e(require("dayjs")),y=e(require("@mui/material/Button")),C=e(require("@mui/material/Dialog")),T=e(require("@mui/material/DialogActions")),v=e(require("@mui/material/DialogContent")),R=e(require("@mui/material/Slide")),I=require("@mui/material/styles"),S=e(require("@mui/material/Menu")),A=e(require("@mui/material/MenuItem")),O=e(require("@mui/icons-material/PlayArrow")),N=e(require("@mui/icons-material/RestartAlt")),x=e(require("@mui/icons-material/VideoCall")),_=e(require("@mui/icons-material/KeyboardArrowDown")),b=require("react-aspect-ratio"),G=e(require("react-infinite-scroller")),k=e(require("@mui/material/List")),M=e(require("axios")),D=e(require("socket.io-client")),w=e(require("@mui/icons-material/SettingsSuggest")),U=e(require("@mui/icons-material/SettingsVoice")),L=e(require("@mui/icons-material/VideoSettings")),j=e(require("i18next")),P=e(require("i18next-browser-languagedetector"));(t=exports.MessageStatus||(exports.MessageStatus={}))[t.sent=0]="sent",t[t.read=1]="read",(a=exports.Role||(exports.Role={}))[a.Unknown=0]="Unknown",a[a.Client=1]="Client",a[a.Agent=2]="Agent",a[a.Specialist=3]="Specialist",a[a.Operator=4]="Operator",(n=exports.ContextMenuType||(exports.ContextMenuType={})).COPY="COPY",n.REVOKE="REVOKE",n.TOP_REVERT="TOP_REVERT",n.TOP="TOP",n.READ="READ",n.DELETE="DELETE";const F=s.makeStyles(()=>s.createStyles({item:{cursor:"pointer"}})),H=e=>{const t=F(),a=t=>{e.onSelect&&e.onSelect(t.target.innerText)},n=e=>r.createElement(l.Box,{m:.5,component:"span",onClick:a,className:t.item},e.emoji);return r.createElement(l.Box,null,r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😃"}),r.createElement(n,{emoji:"😁"}),r.createElement(n,{emoji:"😂"}),r.createElement(n,{emoji:"😄"}),r.createElement(n,{emoji:"😅"}),r.createElement(n,{emoji:"😆"}),r.createElement(n,{emoji:"😇"}),r.createElement(n,{emoji:"😈"}),r.createElement(n,{emoji:"😉"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😊"}),r.createElement(n,{emoji:"😋"}),r.createElement(n,{emoji:"😌"}),r.createElement(n,{emoji:"😍"}),r.createElement(n,{emoji:"😎"}),r.createElement(n,{emoji:"😏"}),r.createElement(n,{emoji:"😐"}),r.createElement(n,{emoji:"😒"}),r.createElement(n,{emoji:"😓"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"❓"}),r.createElement(n,{emoji:"😕"}),r.createElement(n,{emoji:"😖"}),r.createElement(n,{emoji:"😗"}),r.createElement(n,{emoji:"😘"}),r.createElement(n,{emoji:"😙"}),r.createElement(n,{emoji:"😚"}),r.createElement(n,{emoji:"😜"}),r.createElement(n,{emoji:"😝"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😞"}),r.createElement(n,{emoji:"😟"}),r.createElement(n,{emoji:"😠"}),r.createElement(n,{emoji:"😡"}),r.createElement(n,{emoji:"😢"}),r.createElement(n,{emoji:"😣"}),r.createElement(n,{emoji:"😤"}),r.createElement(n,{emoji:"😥"}),r.createElement(n,{emoji:"😦"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😨"}),r.createElement(n,{emoji:"😩"}),r.createElement(n,{emoji:"😪"}),r.createElement(n,{emoji:"😫"}),r.createElement(n,{emoji:"😬"}),r.createElement(n,{emoji:"😭"}),r.createElement(n,{emoji:"😮"}),r.createElement(n,{emoji:"😯"}),r.createElement(n,{emoji:"😰"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"😲"}),r.createElement(n,{emoji:"😳"}),r.createElement(n,{emoji:"😴"}),r.createElement(n,{emoji:"😵"}),r.createElement(n,{emoji:"🧐"}),r.createElement(n,{emoji:"😷"}),r.createElement(n,{emoji:"🙁"}),r.createElement(n,{emoji:"🙂"}),r.createElement(n,{emoji:"🙃"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"🤐"}),r.createElement(n,{emoji:"🤑"}),r.createElement(n,{emoji:"🤒"}),r.createElement(n,{emoji:"🤓"}),r.createElement(n,{emoji:"🤔"}),r.createElement(n,{emoji:"🤕"}),r.createElement(n,{emoji:"🤠"}),r.createElement(n,{emoji:"🤡"}),r.createElement(n,{emoji:"🤢"})),r.createElement(l.Box,{display:"flex",flexDirection:"row"},r.createElement(n,{emoji:"🤤"}),r.createElement(n,{emoji:"🤥"}),r.createElement(n,{emoji:"🤧"}),r.createElement(n,{emoji:"🤨"}),r.createElement(n,{emoji:"🤩"}),r.createElement(n,{emoji:"🤪"}),r.createElement(n,{emoji:"🤫"}),r.createElement(n,{emoji:"🤬"}),r.createElement(n,{emoji:"🤭"})))},B=s.makeStyles(e=>s.createStyles({typingText:{paddingLeft:e.spacing(.5)},typingDot:{display:"inline-block",verticalAlign:"middle",width:4,height:4,margin:"0px 2px",background:e.palette.primary.main,borderRadius:"50%",opacity:"0",animation:"$loadingFade 1s infinite","&:nth-child(1)":{animationDelay:"0s"},"&:nth-child(2)":{animationDelay:"0.2s"},"&:nth-child(3)":{animationDelay:"0.4s"}},"@keyframes loadingFade":{"0%":{opacity:0},"50%":{opacity:.8},"100%":{opacity:0}}})),z=e=>{const t=B();return o.createElement(l.Typography,{color:"primary",variant:"body2",component:"span"},o.createElement("span",{className:t.typingDot}),o.createElement("span",{className:t.typingDot}),o.createElement("span",{className:t.typingDot}),o.createElement("span",{className:t.typingText},e.message))},V=s.makeStyles(()=>({input:{flex:"auto"},inputUpload:{display:"none"},attachmentIcon:{fill:"none",stroke:"currentColor"}})),Y=e=>{const t=V(),{chat:a}=e,{t:n}=m.useTranslation(),[r,s]=o.useState(null),[i,c]=o.useState(""),[u,p]=o.useState({chat:a,time:0}),E=()=>{s(null)},g=t=>{a&&e.onSendMessage&&e.onSendMessage(a,t)},f=()=>{0!==i.trim().length&&(g({message:i,messageType:"text"}),c(""))},h=Boolean(r),y=h?"simple-popover":void 0;return o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement(l.TextField,{className:t.input,placeholder:n("CHAT.INPUT_MESSAGE")||"",autoFocus:!0,variant:"standard",InputProps:{disableUnderline:!0,startAdornment:o.createElement(l.InputAdornment,{position:"start"},o.createElement("input",{accept:".pdf,.jpg,.jpeg,.bmp,.gif,.png,application/pdf,image/jpeg,image/bmp,image/gif,image/png",className:t.inputUpload,id:"icon-button-file",type:"file",onChange:e=>{if(!e.currentTarget.files)return;const t=e.currentTarget.files[0];let a;if(a=t.type.includes("image")?"image":t.type.includes("video")?"video":"file","image"===a){const e=new Image,n=window.URL||window.webkitURL;e.src=n.createObjectURL(t),e.onload=()=>{const n=(e=>{let{width:t,height:a}=e;return(t>335||a>335)&&(t>a?(a=a/t*335,t=335):(t=t/a*335,a=335)),{width:t,height:a}})({width:e.width,height:e.height});g({message:t,width:n.width,height:n.height,messageType:a})}}else g({message:t,messageType:a,fileName:t.name,size:t.size})}}),o.createElement("label",{htmlFor:"icon-button-file"},o.createElement(l.IconButton,{color:"primary","aria-label":"upload",component:"span",size:"small"},o.createElement(l.SvgIcon,{fill:"none",className:t.attachmentIcon},o.createElement("path",{d:"M16.768 13.5767L11.6961 18.6486C9.35886 20.9859 5.56937 20.9859 3.23208 18.6486V18.6486C0.894789 16.3114 0.894789 12.5219 3.23208 10.1846L10.4479 2.96872C12.0875 1.32914 14.7458 1.32914 16.3854 2.96873V2.96873C18.025 4.60831 18.025 7.26659 16.3854 8.90617L9.16515 16.1264C8.23032 17.0612 6.71466 17.0612 5.77982 16.1264V16.1264C4.84499 15.1916 4.84499 13.6759 5.77982 12.7411L10.8896 7.63131",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}))))," ",o.createElement(l.IconButton,{"aria-describedby":y,onClick:e=>{s(e.currentTarget)},color:"primary",size:"small"},o.createElement(d.InsertEmoticon,null))),endAdornment:o.createElement(l.IconButton,{edge:"end",color:"inherit",size:"small",onClick:e=>{e.preventDefault(),f()}},o.createElement(d.Send,null))},value:i,onChange:t=>{let{target:n}=t;c(n.value),a&&e.onTyping&&(u.chat!==a||Date.now()-u.time>=500)&&(p({chat:a,time:Date.now()}),e.onTyping(a))},onKeyPress:e=>{"Enter"===e.key&&(e.preventDefault(),f())}}),o.createElement(l.Popover,{id:y,open:h,anchorEl:r,onClose:E,anchorOrigin:{vertical:"top",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"left"}},o.createElement(H,{onSelect:e=>{c(""+i+e),E()}})))},q=e=>{const{t:t}=m.useTranslation();return e.isTyping?o.createElement(z,{message:t("CHAT.STATUS.TYPING")}):1===e.contact.online?o.createElement(l.Typography,{variant:"body2",color:"primary",component:"span"},t("CHAT.STATUS.ONLINE")):o.createElement(l.Typography,{variant:"body2",color:"textSecondary",component:"span"},t("CHAT.STATUS.OFFLINE"))};function W(e){return null==e||"object"==typeof e&&0===Object.keys(e).length||"string"==typeof e&&0===e.trim().length}function K(e,t){return void 0===t&&(t="DD.MM.YYYY HH:mm"),void 0===e?null:("string"==typeof e&&(e=new Date(e)),h().add(-1,"days").startOf("day").isAfter(e)?h(e).format(t):h().startOf("day").isAfter(e)?"Вчера в "+h(e).format("HH:mm"):h(e).format("HH:mm"))}const J=e=>e?e.groupId?"group:"+e.groupId:"user:"+e.userId:null,$=e=>e.groupId?e.name:e.username,X=e=>Object.values(e).map(e=>null!=(null==e?void 0:e.messages)?null==e?void 0:e.messages.length:0).reduce((e,t)=>e+t,0),Q=(e,t)=>{const a=Array.isArray(e.messages)&&e.messages.length>0,n=Array.isArray(t.messages)&&t.messages.length>0;return a&&n&&null!=t.messages&&null!=e.messages?(null!=t.messages[t.messages.length-1].cdate?new Date(t.messages[t.messages.length-1].cdate).getTime():(new Date).getTime())-(null!=e.messages[e.messages.length-1].cdate?new Date(e.messages[e.messages.length-1].cdate).getTime():(new Date).getTime()-1):a?-1:1},Z=e=>{const t=window.location.search;return new URLSearchParams(t).get(e)},ee=(e,t,a)=>{const n=t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e;return a?n+(n.includes("?")?"&":"?")+new URLSearchParams(a).toString():n},te=s.makeStyles(()=>({star:{fontSize:"0.85rem",verticalAlign:"middle"}})),ae=e=>{const t=te(),{apiUrl:a,contacts:n,owner:r}=e;return o.createElement(l.List,{"aria-label":"contacts"},n.map(n=>o.createElement(l.ListItem,{button:!0,key:n.userId,onClick:()=>e.onClick&&e.onClick(n)},o.createElement(l.ListItemAvatar,null,o.createElement(l.Avatar,{alt:n.username,src:n.avatar?ee(a,n.avatar):""})),o.createElement(l.ListItemText,{primary:o.createElement("span",null,n.username," ",r===n.userId&&o.createElement(f,{className:t.star,color:"primary"})),secondary:o.createElement(q,{contact:n,isTyping:!1})}))))},ne=e=>{const{onClose:t,open:a,apiUrl:n,contacts:r}=e,{t:s}=m.useTranslation();return o.createElement(l.Dialog,{onClose:()=>{t()},"aria-labelledby":"add-contact-title",open:a},o.createElement(l.DialogTitle,{id:"switch-operator-title"},s("CHAT.ADD_CONTACT")),o.createElement(ae,{apiUrl:n,contacts:r,onClick:e=>{t(e)}}))};function re(){return(re=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}const oe=o.forwardRef((function(e,t){return o.createElement(l.Slide,re({direction:"up",ref:t},e))}));function le(e){let{children:t,open:a,setOpen:n,severity:r="warning"}=e;const{t:s}=m.useTranslation(),i=()=>{n(!1)};return o.createElement(l.Dialog,{open:a,TransitionComponent:oe,keepMounted:!0,onClose:i,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description"},o.createElement(l.DialogContent,null,o.createElement(l.Alert,{severity:r},"string"==typeof t?o.createElement(l.Typography,{variant:"body2"},t):t)),o.createElement(l.DialogActions,null,o.createElement(l.Button,{onClick:i,variant:"text"},s("CHAT.BUT_CLOSE"))))}const se=e=>{let{modaleInfo:t,setModaleInfo:a,strTime:n}=e;const{t:s}=m.useTranslation();return r.useMemo(()=>o.createElement(le,{open:t,setOpen:a,severity:"info"},o.createElement(l.Typography,{variant:"body1",textAlign:"center"},s("CHAT.CONFERENCE.UntillTheEnd"),":"),o.createElement(l.Typography,{variant:"h6",textAlign:"center"},n)),[t])},ie=e=>{let{finishDate:t}=e;const{t:a}=m.useTranslation(),[n,s]=r.useState(!1),i=Date.now(),c=new Date(t).getTime(),u=Math.round((c-i)/1e3),{counter:d}=function(e){void 0===e&&(e=3e4);const[t,a]=r.useState(e),n=r.useRef(null);return r.useEffect(()=>(t>0&&(n.current=setInterval(()=>a(e=>e-1),1e3)),()=>{n.current&&clearInterval(n.current)}),[t]),{counter:t,handlerRefresh:()=>{a(e)}}}(u);if(r.useEffect(()=>{null!=p&&3===p&&null!=E&&0===E&&s(!0)},[d]),u<1)return null;const{minutes:p,seconds:E,strTime:g}=(e=>{const t=Math.floor(e/3600),a=t<10?"0"+t:t;e%=3600;const n=Math.floor(e/60),r=e%60;return{hours:t,minutes:n,seconds:r,strTime:a+":"+(n<10?"0"+n:n)+":"+(r<10?"0"+r:r)}})(u);return o.createElement(l.Box,{textAlign:"center"},o.createElement(l.Typography,{variant:"body2",component:"span"},a("CHAT.CONFERENCE.LEFT_TIME"),":"," "),o.createElement(l.Typography,{variant:"button",component:"span"},g),o.createElement(se,{modaleInfo:n,setModaleInfo:s,strTime:g}))},ce=r.forwardRef((function(e,t){return r.createElement(R,re({direction:"up",ref:t},e))}));function ue(e){let{open:t,setOpen:a,contentText:n,callback:o}=e;const{t:s}=m.useTranslation(),i=()=>{a(!1)};return r.createElement(r.Fragment,null,r.createElement(C,{open:t,TransitionComponent:ce,keepMounted:!0,onClose:i,"aria-describedby":"alert-dialog-slide-description"},r.createElement(v,null,r.createElement(l.Typography,{variant:"h6"},n)),r.createElement(T,null,r.createElement(y,{onClick:i,color:"primary"},s("CHAT.BUT_CLOSE")),r.createElement(y,{onClick:()=>{a(!1),o()},color:"warning"},s("CHAT.BUT_CONFIRM")))))}const de=I.styled(e=>r.createElement(S,re({elevation:0,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"}},e)))(e=>{let{theme:t}=e;return{"& .MuiPaper-root":{borderRadius:6,marginTop:t.spacing(1),minWidth:180,color:"light"===t.palette.mode?"rgb(55, 65, 81)":t.palette.grey[300],boxShadow:"rgb(255, 255, 255) 0px 0px 0px 0px, rgba(0, 0, 0, 0.05) 0px 0px 0px 1px, rgba(0, 0, 0, 0.1) 0px 10px 15px -3px, rgba(0, 0, 0, 0.05) 0px 4px 6px -2px","& .MuiMenu-list":{padding:"4px 0"},"& .MuiMenuItem-root":{"& .MuiSvgIcon-root":{fontSize:18,color:t.palette.text.secondary,marginRight:t.spacing(1.5)},"&:active":{backgroundColor:I.alpha(t.palette.primary.main,t.palette.action.selectedOpacity)}}}}});function me(e){const{t:t}=m.useTranslation(),[a,n]=r.useState(null),[o,l]=r.useState(null),[s,i]=r.useState(!1),c=Boolean(a),u=r.useMemo(()=>e.visitData.filter(t=>t.contactId===e.chat.userId),[e.visitData,e.chat]);return r.createElement("div",null,r.createElement(y,{id:"conference-button","aria-controls":c?"conference-menu":void 0,"aria-haspopup":"true","aria-expanded":c?"true":void 0,color:"primary",size:"small",variant:"contained",disableElevation:!0,onClick:e=>{n(e.currentTarget)},startIcon:r.createElement(x,null),endIcon:r.createElement(_,null),disabled:0===u.length},t("CHAT.CONFERENCE.START")),r.createElement(ue,{open:s,setOpen:i,contentText:t("CHAT.CONFERENCE.CONFIRM_RECREATE_CONF"),callback:()=>{o&&s&&e.onVideoCall(e.chat,o,!0)}}),r.createElement(de,{id:"conference-menu",MenuListProps:{"aria-labelledby":"conference-button"},anchorEl:a,open:c,onClose:()=>{n(null)}},u.map(t=>r.createElement(A,{onClick:()=>(t=>{n(null),l(t.visitId),"finished"===t.conferenceStatus?i(!0):e.onVideoCall(e.chat,t.visitId)})(t),key:t.visitId,value:t.visitId,disableRipple:!0},r.createElement("finished"===t.conferenceStatus?N:O,null),(e=>{const t=new Date(e.visitDate);return e.plExamName+" ("+K(t,"HH:mm")+" - "+K(new Date(t.getTime()+6e4*e.duration),"HH:mm")+")"})(t)))))}const pe=s.makeStyles(e=>s.createStyles({popover:{pointerEvents:"none"},paper:{padding:e.spacing(1)},avatarGroup:{backgroundColor:"#28B7C6",color:"#fff"}})),Ee=(e,t)=>{var a;const n=[(null==(a=e.members)?void 0:a.length)+" "+t("CHAT.MEMBERS")],r=(e.members||[]).reduce((e,t)=>t.online?e+1:e,0);return r&&n.push(r+" "+t("CHAT.STATUS.ONLINE")),n.join(", ")},ge=e=>{let{apiUrl:t,user:a,chat:n,typing:s,conference:i,visitData:u,conferenceJoined:d,className:f,operators:h,onVideoCall:y,onVideoEnd:C,onConferencePause:T,onOperatorAdd:v,onLeaveGroup:R}=e;const I=pe(),{t:S}=m.useTranslation(),[A,O]=r.useState(null),[N,x]=r.useState(!1),[_,b]=o.useState(!1);if(!n)return o.createElement(l.CardHeader,{avatar:o.createElement(l.Avatar,null),title:"",subheader:"",className:f});const G=()=>{O(null)},k=n;var M;if(k.groupId)return o.createElement(l.CardHeader,{avatar:o.createElement(l.Avatar,{alt:k.name,className:I.avatarGroup},o.createElement(p,null)),title:k.name,subheader:o.createElement(o.Fragment,null,o.createElement("span",{"aria-owns":A?"mouse-over-popover":void 0,"aria-haspopup":"true",onMouseEnter:e=>{O(e.currentTarget)},onMouseLeave:G},Ee(k,S)),o.createElement(l.Popover,{id:"mouse-over-popover",className:I.popover,classes:{paper:I.paper},open:!!A,anchorEl:A,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},onClose:G,disableRestoreFocus:!0},o.createElement(ae,{apiUrl:t,contacts:k.members,owner:k.userId}))),className:f,action:o.createElement(o.Fragment,null,4===a.role&&o.createElement(o.Fragment,null,o.createElement(l.IconButton,{"aria-label":"add user",onClick:()=>{x(!0)}},o.createElement(g,null)),o.createElement(ne,{apiUrl:t,open:N,contacts:h,onClose:e=>{x(!1),v&&e&&n&&v(n,e)}})),4===a.role&&(null==(M=k.members)?void 0:M.find(e=>e.userId!==a.userId&&4===e.role))&&R&&o.createElement(l.IconButton,{"aria-label":"leave group",onClick:()=>R(k)},o.createElement(c,null)))});const D=n,w=!(null==s||!s.contactId)&&(null==s?void 0:s.userId)===D.userId;return o.createElement(l.CardHeader,{avatar:o.createElement(l.Avatar,{alt:D.username,src:D.avatar?ee(t,D.avatar):""}),title:D.username,subheader:o.createElement(q,{contact:D,isTyping:w}),className:f,action:o.createElement(o.Fragment,null,1!==a.role&&d&&i&&!W(i)&&null!=T&&o.createElement(l.Button,{"aria-label":"cancel call",variant:"contained",color:"secondary",size:"small",startIcon:o.createElement(E,{color:"error"}),onClick:()=>T(i)},S("CHAT.CONFERENCE.PAUSE")),i&&!W(i)&&null!=C&&null!=a.role&&[3,4].includes(a.role)&&o.createElement(o.Fragment,null,o.createElement(l.Button,{"aria-label":"cancel call",variant:"contained",color:"primary",size:"small",startIcon:o.createElement(E,{color:"error"}),onClick:()=>b(!0),style:{marginLeft:8}},S("CHAT.CONFERENCE.FINISH")),o.createElement(ue,{open:_,setOpen:b,contentText:S("CHAT.CONFERENCE.CONFIRM_FINISH_CONF"),callback:()=>{C(i)}})),W(i)&&null!=y&&a.role&&[3,4].includes(a.role)&&o.createElement(me,{visitData:u,chat:D,onVideoCall:y}),null!=(null==i?void 0:i.finishDate)&&o.createElement(ie,{finishDate:i.finishDate}))})},fe=s.makeStyles(e=>s.createStyles({fileIcon:{fontSize:"0.75rem"},fileBody:{paddingLeft:e.spacing(1.2)}})),he=e=>{let{message:t}=e;const a=fe(),n=function(e){const t=e.split("$"),[a,n,r,o]=t;return{date:a,userId:n,size:r,name:o}}(t.content),{name:r,ext:s}=function(e){const t=e.lastIndexOf(".");return-1===t?{name:e,ext:""}:{name:e.slice(0,t),ext:e.slice(t+1)}}(n.name);return o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement(l.Avatar,{className:a.fileIcon},s.toUpperCase()),o.createElement(l.Box,{display:"flex",flexDirection:"column",className:a.fileBody},r,o.createElement("span",null,s+" "+n.size)))},ye=s.makeStyles(e=>({mediaContent:{backgroundColor:e.palette.secondary.main,borderRadius:e.spacing(1.2),maxWidth:284,height:190,[e.breakpoints.down("sm")]:{maxWidth:250,height:170}}})),Ce=e=>{let{apiUrl:t,message:a,isConference:n}=e;const r=ye();let l="";if(n){const e=JSON.parse(a.content);l=ee(t,"/static/conf/"+e.visitId+"/"+e.name)}else l=ee(t,"/static/file/"+a.content);return o.createElement("video",{src:l,className:r.mediaContent,controls:!0,muted:!0,preload:"none"},"Ваш браузер не поддерживает тег video.")},Te=s.makeStyles(e=>s.createStyles({img:{cursor:"pointer",borderRadius:e.spacing(1.2),maxWidth:284,maxHeight:190,[e.breakpoints.down("sm")]:{maxWidth:250,maxHeight:170}},aspect:{maxWidth:284,height:190,[e.breakpoints.down("sm")]:{maxWidth:250,height:170}}})),ve=e=>{let{apiUrl:t,message:a,setViewerData:n}=e;const r=Te();return o.createElement(b.AspectRatio,{ratio:"3/4",className:r.aspect},o.createElement("img",{src:ee(t,"/static/image/"+a.content),onClick:()=>{n({visible:!0,src:ee(t,"/static/image/"+a.content)})},className:r.img,alt:a.cdate}))},Re=e=>{let{apiUrl:t,message:a,setViewerData:n}=e;switch(a.messageType){case"text":return o.createElement(o.Fragment,null,a.content);case"video":case"video_conference":return o.createElement(Ce,{message:a,apiUrl:t,isConference:"video_conference"===a.messageType});case"image":return o.createElement(ve,{message:a,apiUrl:t,setViewerData:n});case"file":return o.createElement(he,{message:a})}return null};var Ie=s.makeStyles(e=>s.createStyles({rootContact:{padding:1,paddingLeft:e.spacing(2),"& span":{float:"right",color:e.palette.text.secondary,fontSize:"0.8rem"},"& $message":{backgroundColor:e.palette.grey[200],color:e.palette.text.primary,borderTopRightRadius:e.spacing(3),borderBottomRightRadius:e.spacing(3)},"& $firstMessage":{borderTopLeftRadius:e.spacing(3),marginTop:10},"& $lastMessage":{borderTopRightRadius:e.spacing(3),borderBottomLeftRadius:0,borderBottomRightRadius:e.spacing(3),marginBottom:10}},rootUser:{padding:1,paddingRight:e.spacing(2),justifyContent:"flex-end","& span":{float:"right",color:"#D9DEEC",fontSize:"0.8rem"},"& $message":{backgroundColor:e.palette.primary.main,color:e.palette.primary.contrastText,borderTopLeftRadius:e.spacing(3),borderBottomLeftRadius:e.spacing(3)},"& $firstMessage":{borderTopRightRadius:e.spacing(3),marginTop:10},"& $lastMessage":{borderTopLeftRadius:e.spacing(3),borderBottomRightRadius:0,marginBottom:10}},rootNotify:{justifyContent:"center","& span":{float:"right",color:e.palette.text.secondary,fontSize:"0.8rem"},"& > *":{borderRadius:e.spacing(3),fontWeight:500}},message:{maxWidth:"65%",[e.breakpoints.down("md")]:{maxWidth:"95%"},[e.breakpoints.down("sm")]:{maxWidth:"85%"},borderRadius:e.spacing(.6),padding:e.spacing(.9),paddingLeft:e.spacing(1.8),paddingRight:e.spacing(1.8)},firstMessage:{},lastMessage:{},file:{display:"flex",flexDirection:"row",flexWrap:"wrap",cursor:"pointer"},header:{flex:"0 0 100%",overflow:"hidden",fontWeight:"bold"},body:{flex:"1 1 auto",wordBreak:"break-word",overflow:"hidden"},status:{paddingLeft:e.spacing(1),flex:"1 1 auto",alignSelf:"flex-end"},statusImage:{fontSize:"1rem",marginRight:e.spacing(.5),verticalAlign:"middle"}}));const Se=r.memo(r.forwardRef((e,t)=>{const a=Ie(),{t:n}=m.useTranslation(),{apiUrl:r,message:s,owner:i,user:c,isGroupMessage:u,isUserFirst:p,isUserLast:E,setViewerData:g}=e;if("notify"===s.messageType){const e="{"===s.content[0]?JSON.parse(s.content):s.content;return o.createElement(l.ListItem,{className:a.rootNotify,ref:t},o.createElement(l.Alert,{severity:"string"==typeof e?"info":e.severity},"string"==typeof e?e:e.message))}if(s.isRevoke)return o.createElement(l.ListItem,{className:a.rootNotify,ref:t},o.createElement(l.Typography,{variant:"body2",align:"center"},s.userId===c.userId?n("CHAT.MESSAGE.REVOKED.YOU"):s.revokeUserName+" "+n("CHAT.MESSAGE.REVOKED.CONTACT")));const f=c.userId===s.userId;return o.createElement(l.ListItem,{ref:t,className:"video_conference"===s.messageType?a.rootNotify:f?a.rootUser:a.rootContact},((e,t,a,n,r,s,i)=>{const{messageType:c}=t,u=n&&r?a.message+" "+a.firstMessage+" "+a.lastMessage:n?a.message+" "+a.firstMessage:r?a.message+" "+a.lastMessage:a.message;return"file"===c?o.createElement(l.Link,{className:u+" "+a.file,underline:"none",href:ee(e,"/static/file/"+t.content),target:"_blank",download:!0,onContextMenu:s},i):o.createElement(l.Box,{display:"flex",flexDirection:"image"===c||"video"===c||"video_conference"===c?"column":"row",flexWrap:"wrap",className:u,onContextMenu:s},i)})(r,s,a,p,E,e.onContextMenu,o.createElement(o.Fragment,null,!f&&u&&i&&p&&o.createElement("div",{className:a.header},i.username),o.createElement("div",{className:a.body},o.createElement(Re,{message:s,apiUrl:r,setViewerData:g})),o.createElement("div",{className:a.status},o.createElement("span",null,f?o.createElement(0===s.status?d.Done:d.DoneAll,{className:a.statusImage}):null,K(s.cdate))))))}));Se.displayName="Message";const Ae={userId:0,username:"",password:"",avatar:"",langCode:""},Oe={user:Ae,token:"",refreshToken:"",activeRoom:null,chatOld:null,groupGather:{},userGather:{},contactGather:{},operators:[],initialContactId:null,conference:{data:null,joined:!1,ringPlayed:!1},typing:null,loading:!1,error:void 0,success:void 0,visitData:[]},Ne=e=>e.activeRoom?e.groupGather[e.activeRoom.groupId]||e.contactGather[e.activeRoom.userId]:null,xe=e=>{const{activeRoom:t,initialContactId:a,contactGather:n}=e;let r=null;if(a)r=n[a];else if(t)r=Ne(e);else{const t=[...Object.values(e.contactGather),...Object.values(e.groupGather)].sort(Q);t.length>0&&(r=t[0])}return r},_e=(e,t,a)=>{const n={...e};e.contactGather[t]&&(n.contactGather[t]={...n.contactGather[t],online:a});for(const n of Object.values(e.groupGather)){if(!n.members)continue;const e=n.members.find(e=>e.userId===t);if(e){const t=n.members.indexOf(e);n.members[t]={...e,online:a}}}const r=n.operators.findIndex(e=>e.userId===t);return-1!==r&&(n.operators[r]={...n.operators[r],online:a}),n.activeRoom=Ne(n),n},be=(e,t,a)=>{const n={...e};return n.contactGather[t]&&(n.contactGather[t]={...n.contactGather[t],unreadCount:a(n.contactGather[t].unreadCount)}),n.activeRoom=Ne(n),n},Ge=(e,t,a)=>{const n={...e};return n.groupGather[t]&&(n.groupGather[t]={...n.groupGather[t],unreadCount:a(n.groupGather[t].unreadCount)}),n.activeRoom=Ne(n),n};function ke(e,t){switch(t.type){case"SET_GROUP_GATHER":return{...e,groupGather:{...e.groupGather,[t.payload.groupId]:t.payload}};case"SET_CONTACT_GATHER":return{...e,contactGather:{...e.contactGather,[t.payload.userId]:t.payload}};case"DEL_GROUP":return((e,t)=>{const a={...e},n=a.activeRoom===a.groupGather[t];return delete a.groupGather[t],n&&(a.activeRoom=xe(a)),a})(e,t.payload);case"DEL_GROUP_MEMBER":return((e,t)=>{const a={...e},n=a.groupGather[t.groupId];var r;return n&&(n.members=null==(r=n.members)?void 0:r.filter(e=>e.userId!==t.userId)),a})(e,t.payload);case"DEL_CONTACT":return((e,t)=>{const a={...e},n=a.activeRoom===a.contactGather[t];return delete a.contactGather[t],n&&(a.activeRoom=xe(a)),a})(e,t.payload.userId);case"SET_USER_GATHER":return{...e,userGather:{...e.userGather,[t.payload.userId]:t.payload}};case"UPDATE_ACTIVE_ROOM":return{...e,activeRoom:xe(e)};case"SET_ACTIVE_ROOM":return((e,t)=>({...e,chatOld:null!=e.activeRoom?{...e.activeRoom}:null,activeRoom:t.groupId?e.groupGather[t.groupId]:t.contactId?e.contactGather[t.contactId]:null}))(e,t.payload);case"USER_ONLINE":return _e(e,t.payload,1);case"USER_OFFLINE":return _e(e,t.payload,0);case"ADD_GROUP_MESSAGE":return((e,t)=>{const a={...e},{groupId:n}=t;a.groupGather[n]&&(a.groupGather[n].messages?a.groupGather[n].messages=[...a.groupGather[n].messages,t]:a.groupGather[n]={...e.groupGather[n],messages:[t]});const{activeRoom:r}=a;return r&&r.groupId!==n&&t.userId!==e.user.userId?Ge(a,n,e=>(e||0)+1):(a.activeRoom=Ne(a),a)})(e,t.payload);case"ADD_PRIVATE_MESSAGE":return((e,t)=>{var a;const n={...e},r=t.contactId===e.user.userId?t.userId:t.contactId;return n.contactGather[r].messages?n.contactGather[r].messages=[...n.contactGather[r].messages,t]:n.contactGather[r]={...n.contactGather[r],messages:[t]},(null==(a=n.activeRoom)?void 0:a.userId)!==r&&t.userId!==e.user.userId?be(n,r,e=>(e||0)+1):(n.activeRoom=Ne(n),n)})(e,t.payload);case"ADD_GROUP_UNREAD_GATHER":return Ge(e,t.payload,e=>(e||0)+1);case"ADD_CONTACT_UNREAD_GATHER":return be(e,t.payload,e=>(e||0)+1);case"SET_TYPING":return{...e,typing:t.payload};case"LOSE_GROUP_UNREAD_GATHER":return Ge(e,t.payload,()=>0);case"LOSE_CONTACT_UNREAD_GATHER":return be(e,t.payload,()=>0);case"REVOKE_MESSAGE":return((e,t)=>{const{userId:a}=e.user,n={...e},r=t.username||n.userGather[t.userId].username;if(t.groupId){const{messages:e}=n.groupGather[t.groupId];if(e){const a=e.find(e=>e._id===t._id);if(a){const t=e.indexOf(a);e[t]={...a,isRevoke:!0,revokeUserName:r}}}}else{const{messages:e}=n.contactGather[t.contactId===a?t.userId:t.contactId];if(e){const a=e.find(e=>e._id===t._id);if(a){const t=e.indexOf(a);e[t]={...a,isRevoke:!0,revokeUserName:r}}}}return n.activeRoom=Ne(n),n})(e,t.payload);case"UPDATE_GROUP_INFO":return((e,t)=>{const a={...e},{groupId:n,name:r,notice:o}=t,l=a.groupGather[n];return l&&(a.groupGather[n]={...l,name:r,notice:o}),a.activeRoom=Ne(a),a})(e,t.payload);case"UPDATE_USER_INFO":return((e,t)=>{const a={...e},{userId:n,username:r,avatar:o}=t;return a.userGather[n]&&(a.userGather[n]={...a.userGather[n],username:r,avatar:o}),a.contactGather[n]&&(a.contactGather[n]={...a.contactGather[n],username:r,avatar:o}),a.activeRoom=Ne(a),a})(e,t.payload);case"ADD_GROUP_MEMBER":return((e,t)=>{const a=t.members.map(e=>({...e,isManager:0})),n={...e};return n.groupGather[t.groupId].members&&a?n.groupGather[t.groupId].members=[...e.groupGather[t.groupId].members,...a]:n.groupGather[t.groupId]={...n.groupGather[t.groupId],members:a},n.activeRoom=Ne(n),n})(e,t.payload);case"SET_CONFERENCE":return((e,t)=>({...e,conference:{data:{...t},joined:(null==t?void 0:t.userId)===e.user.userId,ringPlayed:(null==t?void 0:t.userId)!==e.user.userId}}))(e,t.payload);case"JOIN_CONFERENCE":return{...e,conference:{data:{...t.payload},joined:!0,ringPlayed:!1}};case"PAUSE_CONFERENCE":return((e,t)=>{var a;return(null==(a=e.conference.data)?void 0:a.id)!==(null==t?void 0:t.id)?e:{...e,conference:{data:{...e.conference.data},joined:!1,ringPlayed:!1}}})(e,t.payload);case"STOP_CONFERENCE":return((e,t)=>{var a;return(null==(a=e.conference.data)?void 0:a.id)!==(null==t?void 0:t.id)?e:{...e,conference:{data:null,joined:!1,ringPlayed:!1}}})(e,t.payload);case"MARK_PRIVATE_MESSAGES_READ":return((e,t)=>{const a={...e};if(a.contactGather[t]){const e={...a.contactGather[t]};if(e.messages)for(let t=0;t<e.messages.length;t++)e.messages[t]={...e.messages[t],status:1};a.contactGather[t]=e}if(a.activeRoom=Ne(a),null!=a.activeRoom&&a.activeRoom.messages)for(let e=0;e<a.activeRoom.messages.length;e++)a.activeRoom.messages[e]={...a.activeRoom.messages[e],status:1};return a})(e,t.payload);case"ADD_PRIVATE_MESSAGES":return((e,t)=>{const a={...e},{messages:n,contactId:r}=t;return a.contactGather[r]&&(a.contactGather[r]={...a.contactGather[r],messages:[...n||[],...a.contactGather[r].messages||[]],noMoreData:!(null==n||!n.length)&&(null==n?void 0:n.length)<t.pageSize}),a.activeRoom=Ne(a),a})(e,t.payload);case"ADD_GROUP_MESSAGES":return((e,t)=>{const a={...e},{groupId:n,messages:r,userArr:o}=t;a.groupGather[n]&&(a.groupGather[n]={...a.groupGather[n],messages:[...r||[],...a.groupGather[n].messages||[]],noMoreData:!(null==r||!r.length)&&(null==r?void 0:r.length)<t.pageSize}),a.userGather={...a.userGather};for(const e of o)a.userGather[e.userId]||(a.userGather[e.userId]=e);return a.activeRoom=Ne(a),a})(e,t.payload);case"SET_LOADING":return{...e,loading:t.payload,error:""};case"SET_ERROR":return{...e,error:t.payload,success:void 0};case"SET_SUCCES":return{...e,success:t.payload,error:void 0};case"SET_TOKEN":return((e,t)=>({...e,token:t}))(e,t.payload);case"SET_USER":return{...e,user:t.payload};case"CLEAR_USER":return(e=>({...e,token:"",user:Ae}))(e);case"CLEAR_CHAT_DATA":return{...e,activeRoom:null,groupGather:{},userGather:{},contactGather:{},conference:{data:null,joined:!1,ringPlayed:!1},typing:null};case"SET_OPERATORS":return{...e,operators:t.payload};case"SET_VISIT_DATA":return{...e,visitData:t.payload}}return e}const Me=o.createContext({state:Oe,dispatch:()=>null}),De=e=>{Ae.langCode=e.defLang;const t=e.token,a=e.token,n={...Oe,token:t,refreshToken:a},[l,s]=o.useReducer(ke,n),i=r.useMemo(()=>({state:l,dispatch:s}),[l]);return o.createElement(Me.Provider,{value:i},e.children)},we=s.makeStyles(e=>s.createStyles({messageListOuter:{flex:1,overflowY:"auto",margin:0,padding:0},messageList:{height:"100%",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:e.palette.primary.light+" #fff"},img:{cursor:"pointer",borderRadius:e.spacing(1.2),maxWidth:"auto",maxHeight:"95%",[e.breakpoints.down("sm")]:{maxWidth:"auto",maxHeight:"95%"}},arrowDown:{position:"absolute",left:"94.5%",bottom:105,[e.breakpoints.down("md")]:{left:"91.5%",bottom:95},[e.breakpoints.down("sm")]:{left:"84%",bottom:95}}})),Ue=e=>{let{loading:t}=e;return t&&o.createElement(l.Box,{sx:{width:"100%",mx:"auto",textAlign:"center"}},o.createElement(l.CircularProgress,null))},Le=e=>{var t,a;const{apiUrl:n,user:r,users:s,chat:i,loading:c,pageSize:u,setMenuState:d,initialMenuState:m}=e,p=we(),{dispatch:E}=o.useContext(Me),[g,f]=o.useState(!1),h=null==i?void 0:i.messages,y=(null==h?void 0:h.length)||0,C=h&&h[y-1],T=null!=C&&null!=(t=C.ref)&&t.current?null==C||null==(a=C.ref)?void 0:a.current.offsetHeight:50,[v,R]=o.useState(564),I=h&&h.filter(e=>null!=(null==e?void 0:e.status)&&0===e.status),S=o.useRef(null),[A,O]=o.useState({visible:!1,src:""});o.useEffect(()=>{setTimeout(()=>{N()},500)},[J(i)]);const N=()=>{S.current&&(E({type:"MARK_PRIVATE_MESSAGES_READ",payload:r.userId}),S.current.scrollTop=S.current.scrollHeight,R(S.current.scrollHeight-S.current.scrollTop))};return o.createElement(l.CardContent,{className:p.messageListOuter},o.createElement(l.List,{className:p.messageList,ref:S},o.createElement(G,{pageStart:0,loadMore:()=>{y>=u&&!c&&e.onNeedMoreMessages&&i&&e.onNeedMoreMessages(i)},hasMore:!(!i||i.noMoreData),loader:o.createElement(Ue,{loading:c,key:0}),isReverse:!0,useCapture:!0,useWindow:!1,getScrollParent:()=>{if(S.current){const e=S.current.scrollHeight-S.current.scrollTop;f(S.current.scrollTop<S.current.scrollHeight-v),e>v&&e<v+T&&N()}return S.current}},h&&h.map((t,a)=>{const l=o.createRef();return h[a].ref=l,o.createElement(Se,{ref:l,key:a,apiUrl:n,user:r,message:t,owner:s[t.userId],isGroupMessage:!(null==i||!i.groupId),isUserFirst:0===a||"notify"===h[a-1].messageType||h[a-1].userId!==h[a].userId,isUserLast:a===h.length-1||"notify"===h[a+1].messageType||h[a+1].userId!==h[a].userId,onContextMenu:a=>((t,a)=>{const n="text"===t.messageType,o=r.userId===t.userId&&!!e.onMeesageDelete&&(new Date).getTime()-new Date(t.cdate).getTime()<=12e4;n||o?(a.preventDefault(),d({message:t,mouseX:a.clientX-2,mouseY:a.clientY-4,canCopy:n,canDelete:o})):d(m)})(t,a),setViewerData:O})}))),g&&o.createElement(l.Box,{className:p.arrowDown,textAlign:"center"},o.createElement(l.Fab,{color:"info","aria-label":"add",size:"medium",onClick:N},o.createElement(_,null)),null!=I&&I.length>0&&o.createElement(l.Fab,{color:"warning","aria-label":"add",size:"small",sx:{width:24,height:24,minHeight:24,position:"relative",top:-10,pointerEvents:"none"}},o.createElement(l.Typography,{variant:"body2",sx:e=>({color:e.palette.background.default})},I.length))),A.visible&&o.createElement(l.Backdrop,{sx:{color:"#fff",zIndex:e=>e.zIndex.drawer+1},open:A.visible,onClick:()=>{O({visible:!1,src:""})}},o.createElement("img",{src:A.src,className:p.img,alt:""})))},je=s.makeStyles(e=>s.createStyles({root:{width:"100%",minWidth:360,height:"100%",display:"flex",flexDirection:"column"},roomHeader:{flex:1},flexAll:{flex:"1 1 auto"},flexEnd:{justifyContent:"flex-end"}})),Pe={message:null,mouseX:null,mouseY:null,canCopy:!1,canDelete:!1},Fe=e=>{const{apiUrl:t,user:a,users:n,chat:s,typing:d,conference:p,visitData:E,conferenceJoined:g,loading:f,pageSize:h}=e,y=je(),{t:C}=m.useTranslation(),T=l.useMediaQuery(e=>e.breakpoints.down("sm")),[v,R]=o.useState(Pe),I=r.useCallback(()=>{const{message:e}=v;R(Pe),e&&navigator.clipboard.writeText(e.content)},[v.message]),S=r.useCallback(()=>{const{message:t}=v;R(Pe),e.onMeesageDelete&&s&&t&&e.onMeesageDelete(s,t)},[v.message]);return o.createElement(l.Card,{elevation:1,className:y.root},o.createElement(l.Box,{display:"flex",flexDirection:"row"},s&&T&&o.createElement(l.Tooltip,{title:"Вернуться в конференцию"},o.createElement(l.IconButton,{"aria-label":"exit room",onClick:()=>e.onExitRoom&&e.onExitRoom(s)},o.createElement(u,null))),o.createElement(ge,{apiUrl:t,user:a,chat:s,typing:d,conference:p,visitData:E,conferenceJoined:g,operators:e.operators,className:y.roomHeader,onVideoCall:e.onVideoCall,onVideoEnd:e.onVideoEnd,onConferencePause:e.onConferencePause,onOperatorAdd:e.onOperatorAdd,onLeaveGroup:e.onLeaveGroup})),o.createElement(l.Divider,null),o.createElement(Le,{apiUrl:t,user:a,users:n,chat:s,loading:f,pageSize:h,initialMenuState:Pe,onNeedMoreMessages:e.onNeedMoreMessages,onMeesageDelete:e.onMeesageDelete,setMenuState:R}),o.createElement(l.Divider,null),o.createElement(l.CardContent,null,o.createElement(Y,{chat:s,onTyping:e.onTyping,onSendMessage:e.onSendMessage})),o.createElement(l.Menu,{keepMounted:!0,open:null!==v.mouseY,onClose:()=>{R(Pe)},anchorReference:"anchorPosition",anchorPosition:null!==v.mouseY&&null!==v.mouseX?{top:v.mouseY,left:v.mouseX}:void 0},o.createElement(l.MenuItem,{onClick:I,disabled:!v.canCopy},o.createElement("span",{className:y.flexAll},C("CHAT.MESSAGE.MENU.COPY")),o.createElement(l.ListItemIcon,{className:y.flexEnd},o.createElement(i,{fontSize:"small"}))),o.createElement(l.MenuItem,{onClick:S,disabled:!v.canDelete},o.createElement("span",{className:y.flexAll},C("CHAT.MESSAGE.MENU.DELETE")),o.createElement(l.ListItemIcon,{className:y.flexEnd},o.createElement(c,{fontSize:"small"})))))},He=s.makeStyles(e=>s.createStyles({main:{flex:"1 1 auto",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},time:{paddingLeft:e.spacing(1),justifyContent:"flex-end",whiteSpace:"nowrap"},unread:{justifyContent:"flex-end",maxHeight:20},avatarGroup:{backgroundColor:"#28B7C6",color:"#fff"}})),Be=s.withStyles(e=>s.createStyles({badge:{backgroundColor:"#44b700",color:"#44b700",boxShadow:"0 0 0 2px "+e.palette.background.paper,"&::after":{position:"absolute",top:0,left:0,width:"100%",height:"100%",borderRadius:"50%",animation:"$ripple 1.2s infinite ease-in-out",border:"1px solid currentColor",content:'""'}},"@keyframes ripple":{"0%":{transform:"scale(.8)",opacity:1},"100%":{transform:"scale(2.4)",opacity:0}}}))(l.Badge),ze=s.withStyles(e=>s.createStyles({badge:{backgroundColor:e.palette.primary.main,boxShadow:"0 0 0 2px "+e.palette.background.paper}}))(l.Badge),Ve=e=>{var t;const a=He(),{t:n}=m.useTranslation(),{apiUrl:s,chat:i,typing:c}=e,u=$(i),d=i.groupId?o.createElement(l.Avatar,{alt:u,className:a.avatarGroup},o.createElement(p,null)," "):((e,t,a)=>{const n=o.createElement(l.Avatar,{alt:t.username,src:t.avatar?ee(e,t.avatar):""});return null!=a&&a.contactId&&(null==a?void 0:a.userId)===t.userId?o.createElement(Be,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},variant:"dot"},n):null!=t&&t.online?o.createElement(ze,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},variant:"dot"},n):n})(s,i,c),E=i.messages&&i.messages.length>0?i.messages[i.messages.length-1]:null,g=((e,t)=>{if(!e)return null;switch(e.messageType){case"text":return e.content;case"image":return"["+t("CHAT.MESSAGE.TYPE.IMAGE")+"]";case"video":return"["+t("CHAT.MESSAGE.TYPE.VIDEO")+"]";case"file":return"["+t("CHAT.MESSAGE.TYPE.FILE")+"]";case"notify":return"["+t("CHAT.MESSAGE.TYPE.NOTIFY")+"]";default:return null}})(E,n),f=null==E?void 0:E.cdate;return r.useMemo(()=>o.createElement(l.ListItem,{button:!0,selected:e.active,onClick:e.onClick},o.createElement(l.ListItemAvatar,null,d),o.createElement(l.ListItemText,{secondaryTypographyProps:{component:"span"},primary:o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement("span",{className:a.main},u),o.createElement("span",{className:a.time},K(f))),secondary:o.createElement(l.Box,{display:"flex",flexDirection:"row"},o.createElement("span",{className:a.main},g),i.unreadCount?o.createElement(l.Chip,{className:a.unread,component:"span",size:"small",color:"primary",label:i.unreadCount}):null)})),[null==(t=i.messages)?void 0:t.length])},Ye=s.makeStyles(e=>({root:{width:"100%",height:"100%"},searchField:{width:"100%"},listStyle:{height:"89.5%",overflowY:"auto",scrollbarWidth:"thin",scrollbarColor:e.palette.primary.light+" #fff"}})),qe=(e,t)=>{if(null===t)return e;const a=t.toLowerCase();return e.filter(e=>-1!==$(e).toLowerCase().indexOf(a.toLowerCase()))},We=(e,t,a)=>{let n=[...t,...a];n=n.sort(Q);const r=localStorage.getItem(e+"-topChatId");if(r){const e=n.find(e=>J(e)===r);e&&(n=n.filter(e=>J(e)!==r),e.isTop=!0,n.unshift(e))}return n},Ke=e=>{const t=Ye(),{t:a}=m.useTranslation(),[n,r]=o.useState(We(e.user.userId,qe(e.groups,null),qe(e.contacts,null))),s=o.useMemo(()=>n.map(t=>o.createElement(Ve,{key:J(t),apiUrl:e.apiUrl,chat:t,active:t===e.activeRoom,typing:e.typing,onClick:()=>null!=e.onChangeChat&&e.onChangeChat(t)})),[e.activeRoom,e.typing]);return o.createElement(l.Card,{elevation:1,className:t.root},o.createElement(l.CardHeader,{title:o.createElement(l.TextField,{className:t.searchField,label:a("CHAT.INPUT_SEARCH_CONTACT"),variant:"outlined",size:"small",fullWidth:!0,onChange:t=>{r(We(e.user.userId,qe(e.groups,t.target.value),qe(e.contacts,t.target.value)))}})}),o.createElement(l.Divider,null),o.createElement(k,{"aria-label":"rooms",className:t.listStyle},s))},Je=s.makeStyles(()=>({root:{width:"100%",height:"100%",borderRadius:4}})),$e=e=>{let{conference:t,onClose:a,langCode:n="en"}=e;const l=Je(),s=o.useRef(null),i=null!=t&&t.url&&n?function(e,t,a){const n=new RegExp("(lang=)[^&]+");return e.replace(n,"$1"+a)}(null==t?void 0:t.url,0,(e=>"ru"===e?"rus":"fr"===e?"fra":"en"===e?"eng":"")(n)):"";return r.useEffect(()=>{const e=e=>{var n;let{source:r,data:o}=e;if(r===(null==(n=s.current)?void 0:n.contentWindow)){const{type:e}=o;["notSupported","connectionFail","callFail","hangUp","remoteHangUp"].includes(e)&&a(t)}};return window.addEventListener("message",e),()=>{window.removeEventListener("message",e)}},[null==t?void 0:t.id,n]),o.createElement("iframe",{title:"conference",className:l.root,src:i,allowFullScreen:!0,allow:"microphone; camera; autoplay; display-capture",ref:s})},Xe=s.makeStyles(()=>({root:{width:"100%",height:"100%",borderRadius:8,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"},pulse:{height:100,width:100,borderRadius:"50%",display:"flex",justifyContent:"center",alignItems:"center",position:"relative","&::before":{content:"''",position:"absolute",border:"1px solid green",width:"calc(100% + 40px)",height:"calc(100% + 40px)",borderRadius:"50%",animation:"$pulse 1s linear infinite"},"&::after":{content:"''",position:"absolute",border:"1px solid green",width:"calc(100% + 40px)",height:"calc(100% + 40px)",borderRadius:"50%",animation:"$pulse 1s linear infinite",animationDelay:"0.3s"}},avatar:{width:"80%",height:"80%"},footer:{width:"100%",alignSelf:"flex-end",paddingTop:64,display:"flex",justifyContent:"center"},"@keyframes pulse":{"0%":{transform:"scale(0.5)",opacity:0},"50%":{transform:"scale(1)",opacity:1},"100%":{transform:"scale(1.3)",opacity:0}}})),Qe=e=>{let{conference:t,contact:a,apiUrl:n,onAccept:r}=e;const s=Xe(),{t:i}=m.useTranslation();return o.createElement(l.Paper,{className:s.root},o.createElement("div",{className:s.pulse},o.createElement(l.Avatar,a?{className:s.avatar,alt:a.username,src:a.avatar?ee(n,a.avatar):""}:{className:s.avatar})),o.createElement("div",{className:s.footer},o.createElement(l.Button,{variant:"contained",color:"primary",onClick:()=>r(t)},i("CHAT.CONFERENCE.JOIN"))))},Ze=r.createContext({});function et(){localStorage.removeItem("authToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),localStorage.removeItem("doctor"),localStorage.removeItem("chatUser")}const tt=async()=>{try{await M.post("auth/logout")}catch(e){console.log("ERROR Logout",e)}et(),window.location.href="/"},at=async(e,t,a)=>{try{const{data:a}=await M.post("auth/refreshToken",{authToken:e,refreshToken:t});localStorage.setItem("authToken",null==a?void 0:a.authToken),localStorage.setItem("refreshToken",null==a?void 0:a.refreshToken),window.location.href="/"}catch(e){console.log("ERROR RefreshToken",e),a({type:"CLEAR_USER"}),tt()}},nt=e=>{let{baseURLApi:t,pageSize:a,children:n}=e;const{state:l,dispatch:s}=r.useContext(Me),i=M.create({timeout:6e4,baseURL:t,headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Authorization:"Bearer "+l.token},withCredentials:!1});i.interceptors.response.use(e=>e,e=>(console.log("ERROR AxiosError"),(e=>{null!=e.response&&401===e.response.status&&at(l.token,l.refreshToken,s)})(e),Promise.reject(e)));const c=r.useCallback(async(e,t)=>{var n;const r=e.userId,o=null==(n=e.messages)?void 0:n.length;try{s({type:"SET_LOADING",payload:!0});const{data:e}=await i.get("/contact/messages",{params:{contactId:r,current:o,pageSize:a}});e&&(s({type:"ADD_PRIVATE_MESSAGES",payload:{pageSize:a,contactId:r,messages:e}}),t&&t())}catch(e){s({type:"SET_ERROR",payload:e.message})}finally{s({type:"SET_LOADING",payload:!1})}},[s]),u=r.useCallback(async e=>{var t;const{groupId:n}=e,r=null==(t=e.messages)?void 0:t.length;try{s({type:"SET_LOADING",payload:!0});const{data:e}=await i.get("/group/messages",{params:{groupId:n,current:r,pageSize:a}});e&&s({type:"ADD_GROUP_MESSAGES",payload:{pageSize:a,groupId:n,...e}})}catch(e){s({type:"SET_ERROR",payload:e.message})}finally{s({type:"SET_LOADING",payload:!1})}},[s]),d=async(e,t)=>{try{const{data:a}=await i.get("/contact/find",{params:{mmkId:e,guid:t}});if(null!=a)return a}catch(e){console.log("err getUserByMmk",e)}},m=r.useMemo(()=>({apiUrl:t,pageSize:a,fetch:i,getPrivateMessages:c,getGroupMessages:u,getUserByMmk:d}),[t,a]);return o.createElement(Ze.Provider,{value:m},n)},rt=r.createContext({online:!1}),ot=e=>{var t,a;let{wsUrl:n,wsPath:l,children:s}=e;const{state:i,dispatch:c}=r.useContext(Me),{socket:u,online:d,disconnectSocket:m,connectSocket:p}=((e,t,a)=>{const[n,o]=r.useState(null),l=r.useCallback(()=>{const n=D(e,{path:t,reconnection:!0,extraHeaders:{Authorization:"Bearer "+a}});o(n)},[e,t,a]),s=r.useCallback(()=>{null==n||n.disconnect(),o(null)},[n]),[i,c]=r.useState(!1);return r.useEffect(()=>{c(!(null==n||!n.connected))},[n]),r.useEffect(()=>{null==n||n.on("connect",()=>{c(!0),n.emit("chatData")})},[n]),r.useEffect(()=>{null==n||n.on("disconnect",()=>{c(!1)})},[n]),{socket:n,online:i,disconnectSocket:s,connectSocket:l}})(n,l,i.token);r.useEffect(()=>(i.token&&p(),i.token||m(),()=>{m()}),[i.token]),r.useEffect(()=>{const e=e=>{console.log("unauthorized msg",e),at(i.token,i.refreshToken,c)};null==u||u.on("unauthorized",e);const t=e=>{if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const t=e.data,a=t.groupData,n=t.contactData,r=t.userData;if(c({type:"CLEAR_CHAT_DATA"}),c({type:"SET_USER",payload:t.user}),a.length)for(const e of a)null==u||u.emit("joinGroupSocket",{groupId:e.groupId}),c({type:"SET_GROUP_GATHER",payload:e});if(n.length)for(const e of n)null==u||u.emit("joinPrivateSocket",{contactId:e.userId}),c({type:"SET_CONTACT_GATHER",payload:e});if(c({type:"SET_OPERATORS",payload:t.operatorData}),r.length)for(const e of r)c({type:"SET_USER_GATHER",payload:e});c({type:"UPDATE_ACTIVE_ROOM"}),c({type:"SET_CONFERENCE",payload:t.conferenceData}),c({type:"SET_VISIT_DATA",payload:t.visitData})};null==u||u.on("chatData",t);const a=e=>{c({type:"USER_ONLINE",payload:e.data})};null==u||u.on("userOnline",a);const n=e=>{c({type:"USER_OFFLINE",payload:e.data})};null==u||u.on("userOffline",n);const r=e=>{e.code?c({type:"SET_ERROR",payload:e.msg}):console.log("Успешно вошел в приватный чат")};let o;null==u||u.on("joinPrivateSocket",r);const l=e=>{e.code?c({type:"SET_ERROR",payload:e.msg}):(o&&clearTimeout(o),c({type:"SET_TYPING",payload:e.data}),o=setTimeout(()=>{c({type:"SET_TYPING",payload:null})},1e3))};null==u||u.on("typing",l);const s=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"REVOKE_MESSAGE",payload:e.data})};null==u||u.on("revokeMessage",s);const d=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_GROUP_GATHER",payload:e.data})};null==u||u.on("addGroup",d);const m=e=>{if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const t=e.data;c({type:"SET_CONTACT_GATHER",payload:t}),c({type:"SET_USER_GATHER",payload:t}),null==u||u.emit("joinPrivateSocket",{contactId:t.userId})};null==u||u.on("addContact",m);const p=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"DEL_CONTACT",payload:e.data})};null==u||u.on("deleteContact",p);const E=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"UPDATE_GROUP_INFO",payload:e.data})};null==u||u.on("updateGroupInfo",E);const g=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"UPDATE_USER_INFO",payload:e.data})};null==u||u.on("updateUserInfo",g);const f=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_CONFERENCE",payload:e.data})};null==u||u.on("startConference",f);const h=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"PAUSE_CONFERENCE",payload:e.data})};null==u||u.on("pauseConference",h);const y=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"STOP_CONFERENCE",payload:e.data})};null==u||u.on("stopConference",y);const C=e=>{e.code&&c({type:"SET_ERROR",payload:e.msg})};null==u||u.on("addOperator",C);const T=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_ACTIVE_ROOM",payload:e.data})};null==u||u.on("setActiveRoom",T);const v=e=>{c(e.code?{type:"SET_ERROR",payload:e.msg}:{type:"SET_VISIT_DATA",payload:e.data.visitData})};return null==u||u.on("visitData",v),()=>{null==u||u.off("unauthorized",e),null==u||u.off("chatData",t),null==u||u.off("userOnline",a),null==u||u.off("userOffline",n),null==u||u.off("joinPrivateSocket",r),o&&clearTimeout(o),null==u||u.off("typing",l),null==u||u.off("revokeMessage",s),null==u||u.off("addGroup",d),null==u||u.off("addContact",m),null==u||u.off("deleteContact",p),null==u||u.off("updateGroupInfo",E),null==u||u.off("updateUserInfo",g),null==u||u.off("startConference",f),null==u||u.off("pauseConference",h),null==u||u.off("stopConference",y),null==u||u.off("addOperator",C),null==u||u.off("setActiveRoom",T),null==u||u.off("visitData",v)}},[null==u?void 0:u.id]),r.useEffect(()=>{const e=async e=>{if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const t=e.data;c({type:"ADD_GROUP_MESSAGE",payload:t});const{activeRoom:a}=i;a&&a.groupId===t.groupId&&t.userId!==i.user.userId&&(null==u||u.emit("markAsRead",{groupId:t.groupId,_id:t._id}))};null==u||u.on("groupMessage",e);const t=async e=>{if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const t=e.data;var a;t.contactId!==i.user.userId&&t.userId!==i.user.userId||(c({type:"ADD_PRIVATE_MESSAGE",payload:t}),i.activeRoom&&!i.activeRoom.groupId&&(null==(a=i.activeRoom)?void 0:a.userId)===t.userId&&(null==u||u.emit("markAsRead",{contactId:t.userId,_id:t._id})))};return null==u||u.on("privateMessage",t),()=>{null==u||u.off("groupMessage",e),null==u||u.off("privateMessage",t)}},[null==u?void 0:u.id,null==(t=i.activeRoom)?void 0:t.userId,null==(a=i.activeRoom)?void 0:a.groupId]),r.useEffect(()=>{const e=e=>{if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const t=e.data;t.userId===i.user.userId?c(t.groupId?{type:"LOSE_GROUP_UNREAD_GATHER",payload:t.groupId}:{type:"LOSE_CONTACT_UNREAD_GATHER",payload:t.contactId}):t.contactId&&c({type:"MARK_PRIVATE_MESSAGES_READ",payload:t.userId})};null==u||u.on("markAsRead",e);const t=e=>{if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const t=e.data;c(t.userId===i.user.userId?{type:"DEL_GROUP",payload:t.groupId}:{type:"DEL_GROUP_MEMBER",payload:t})};null==u||u.on("deleteGroup",t);const a=e=>{if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const{group:t,user:a}=e.data;i.groupGather[t.groupId]?a.userId!==i.user.userId&&c({type:"ADD_GROUP_MEMBER",payload:{groupId:t.groupId,members:[a]}}):(console.log("joined to a new group"),null==u||u.emit("chatData"))};null==u||u.on("joinGroup",a);const n=e=>{var t;if(e.code)return void c({type:"SET_ERROR",payload:e.msg});const a=e.data,n=a.user;n.online=1;const{group:r}=a,o=i.groupGather[r.groupId];var l;!o||null!=(t=o.members)&&t.find(e=>e.userId===n.userId)||(n.isManager=0,null==(l=o.members)||l.push(n)),c({type:"SET_USER_GATHER",payload:n})};return null==u||u.on("joinGroupSocket",n),()=>{null==u||u.off("markAsRead",e),null==u||u.off("deleteGroup",t),null==u||u.off("joinGroup",a),null==u||u.off("joinGroupSocket",n)}},[null==u?void 0:u.id,i.user.userId,X(i.groupGather)]);const E=r.useMemo(()=>({socket:u,online:d}),[u,d]);return o.createElement(rt.Provider,{value:E},s)},lt=e=>{let{audio:t,video:a}=e;const{t:n}=m.useTranslation(),{dispatch:r}=o.useContext(Me),s=n(t&&a?"CHAT.CONFERENCE.CheckCamMic":t?"CHAT.CONFERENCE.CheckMic":"CHAT.CONFERENCE.CheckCam");return o.createElement(l.Tooltip,{title:s},o.createElement(l.IconButton,{"aria-label":"check",onClick:()=>{navigator.mediaDevices.getUserMedia({audio:t,video:a}).then(e=>{console.log("permissions",e),r({type:"SET_SUCCES",payload:n("CHAT.CONFERENCE.ALLOK")})}).catch(e=>{let t=n("CHAT.CONFERENCE.ErrorAny");"NotFoundError"===e.name&&(t=n("CHAT.CONFERENCE.NotFoundError")),"NotAllowedError"===e.name&&(t=n("CHAT.CONFERENCE.NotAllowedError")),r({type:"SET_ERROR",payload:t}),console.log("err",e.name+" : "+e.message)})},size:"large"},o.createElement(t&&a?w:t?U:L,null)))},st=()=>{const{state:{error:e,success:t},dispatch:a}=o.useContext(Me),n=()=>{a({type:"SET_ERROR",payload:void 0}),a({type:"SET_SUCCES",payload:void 0})};return o.createElement(l.Snackbar,{anchorOrigin:{vertical:"top",horizontal:"center"},open:!!e||!!t,autoHideDuration:6e3,onClose:n},o.createElement(l.Alert,{onClose:n,severity:e?"error":"success"},e||t))},it=s.makeStyles(e=>({root:{height:"100%",overflow:"hidden",padding:0,[e.breakpoints.down("sm")]:{width:"100%"}},innerGrid:{height:"100%",width:"100%"},conAbsOnConf:{position:"absolute",top:42,left:25,zIndex:1e3,margin:e.spacing(3)}})),ct=e=>{var t,a,n,o,s,i,c;let{activeGroupId:u,activeChatUserId:p,inModale:E=!0,hideRooms:g=!1}=e;const f=it(),h=l.useMediaQuery(e=>e.breakpoints.down("sm")),{t:y}=m.useTranslation(),{state:C,dispatch:T}=r.useContext(Me),{socket:v}=r.useContext(rt),{apiUrl:R,pageSize:I,getPrivateMessages:S,getGroupMessages:A,getUserByMmk:O}=r.useContext(Ze),N=r.useCallback(()=>{T({type:"SET_ACTIVE_ROOM",payload:{}})},[T]),x=r.useCallback(async e=>{e.groupId?await A(e):await S(e)},[S,A]),_=r.useCallback((e,t)=>{null==v||v.emit("revokeMessage",{groupId:e.groupId,contactId:e.userId,_id:t._id})},[null==v?void 0:v.id]),b=r.useCallback(e=>{null==v||v.emit("typing",{groupId:null==e?void 0:e.groupId,contactId:null==e?void 0:e.userId})},[null==v?void 0:v.id]),G=r.useCallback((e,t)=>{e.groupId?null==v||v.emit("groupMessage",{groupId:null==e?void 0:e.groupId,content:t.message,width:t.width,height:t.height,fileName:t.fileName,messageType:t.messageType,size:t.size}):null==v||v.emit("privateMessage",{contactId:null==e?void 0:e.userId,content:t.message,width:t.width,height:t.height,fileName:t.fileName,messageType:t.messageType,size:t.size})},[null==v?void 0:v.id]),k=r.useCallback(e=>{T({type:"SET_ACTIVE_ROOM",payload:{groupId:null==e?void 0:e.groupId,contactId:null==e?void 0:e.userId}}),M(e)},[null==v?void 0:v.id,T]),M=r.useCallback(e=>{e.messages&&0!==e.messages.length&&(e.groupId?null==v||v.emit("markAsRead",{groupId:e.groupId,_id:e.messages[e.messages.length-1]._id}):null==v||v.emit("markAsRead",{contactId:e.userId,_id:e.messages[e.messages.length-1]._id}))},[null==v?void 0:v.id]),D=r.useCallback((e,t,a)=>{null==v||v.emit("startConference",{groupId:e.groupId,contactId:e.userId,visitId:t,recreate:a})},[null==v?void 0:v.id]),w=r.useCallback(e=>{null!=(null==e?void 0:e.id)&&(null==v||v.emit("stopConference",{id:null==e?void 0:e.id}))},[null==v?void 0:v.id]),U=r.useCallback(e=>{null!=(null==e?void 0:e.id)&&(null==v||v.emit("pauseConference",{id:e.id}))},[null==v?void 0:v.id]),L=r.useCallback(e=>{null!=(null==e?void 0:e.id)&&(null==v||v.emit("resumeConference",{id:e.id})),T({type:"JOIN_CONFERENCE",payload:e})},[null==v?void 0:v.id,T]),j=r.useCallback((e,t)=>{null==v||v.emit("addOperator",{groupId:e.groupId,operatorId:t.userId})},[null==v?void 0:v.id]),P=r.useCallback(e=>{null==v||v.emit("deleteGroup",{groupId:e.groupId})},[null==v?void 0:v.id]);r.useEffect(()=>{if(null!=p&&!W(C.contactGather)){const e=Object.values(C.contactGather).find(e=>e.userId===p);k(e)}const e=Z("mmk"),t=Z("guid");null==e&&null==t||W(C.contactGather)||(async()=>{const a=await O(e,t);if(null!=a){const e=Object.values(C.contactGather).find(e=>e.userId===a);k(e)}})()},[X(C.contactGather)]),r.useEffect(()=>{if(null!=u&&!W(C.groupGather)){const e=Object.values(C.groupGather).find(e=>e.groupId===u);W(e)||k(e)}},[X(C.groupGather)]);const F=null!=C.activeRoom&&r.createElement(Fe,{apiUrl:R,user:C.user,users:C.userGather,operators:C.operators,chat:C.activeRoom,typing:C.typing,conference:C.conference.data,visitData:C.visitData,conferenceJoined:C.conference.joined,loading:C.loading,pageSize:I,onExitRoom:N,onEnterRoom:M,onNeedMoreMessages:x,onMeesageDelete:_,onTyping:b,onSendMessage:G,onVideoCall:D,onVideoEnd:w,onConferencePause:U,onOperatorAdd:j,onLeaveGroup:P}),H=()=>r.createElement(Ke,{apiUrl:R,user:C.user,activeRoom:C.activeRoom,groups:Object.values(C.groupGather),contacts:Object.values(C.contactGather),typing:C.typing,onChangeChat:k}),B=()=>C.conference.data&&r.createElement(Qe,{apiUrl:R,contact:C.contactGather[C.user.userId===C.conference.data.userId?C.conference.data.contactId:C.conference.data.userId],conference:C.conference.data,onAccept:L}),z=()=>r.createElement($e,{conference:C.conference.data,onClose:U,langCode:C.user.langCode}),V=()=>C.conference.joined?r.createElement(r.Fragment,null,r.createElement(z,null),r.createElement(l.Box,{className:f.conAbsOnConf},r.createElement(l.Paper,{style:{borderRadius:8}},r.createElement(l.Box,{display:"flex",flexDirection:"row",my:3},(W(C.activeRoom)&&h||!W(C.activeRoom)&&!h)&&r.createElement(r.Fragment,null,r.createElement(lt,{audio:!0,video:!1}),r.createElement(lt,{audio:!1,video:!0})),W(C.activeRoom)&&null!=C.chatOld&&h&&r.createElement(l.Tooltip,{title:y("CHAT.CONFERENCE.BACK")},r.createElement(l.IconButton,{"aria-label":"check",onClick:()=>null!=C.chatOld&&k(C.chatOld),size:"large"},r.createElement(d.ArrowForward,null))))))):r.createElement(B,null),Y=r.useMemo(()=>{var e;return null!=(null==(e=C.conference.data)?void 0:e.id)?r.createElement(V,null):r.createElement(H,null)},null!=(null==(t=C.conference.data)?void 0:t.id)?[C.conference.joined,null==(a=C.conference.data)?void 0:a.id]:[null==(n=C.activeRoom)?void 0:n.groupId,null==(o=C.activeRoom)?void 0:o.userId,X(C.contactGather),X(C.groupGather)]);return r.createElement(l.Container,{maxWidth:"lg",className:f.root,sx:e=>({width:E?"calc(100vw - "+e.spacing(8)+")":"100%"})},h?r.createElement(r.Fragment,null,Y,F):r.createElement(l.Grid,{container:!0,spacing:1,className:f.innerGrid},(null!=(null==(s=C.conference.data)?void 0:s.id)||!g)&&r.createElement(l.Grid,{item:!0,sm:null!=(null==(i=C.conference.data)?void 0:i.id)?6:4,className:f.innerGrid},Y),r.createElement(l.Grid,{item:!0,sm:null!=(null==(c=C.conference.data)?void 0:c.id)?6:g?12:8,className:f.innerGrid},F)),r.createElement(st,null))},ut=(()=>{const e=localStorage.getItem("user");if(e){const t=JSON.parse(e);return null==t?void 0:t.lang}return"ru"})();j.use(P).use(m.initReactI18next).init({resources:{ru:{translations:{CHAT:{STATUS:{ONLINE:"в сети",OFFLINE:"не в сети",TYPING:"печатает"},MESSAGE:{TYPE:{IMAGE:"Изображение",VIDEO:"Видео",FILE:"Файл",NOTIFY:"Уведомление"},MENU:{COPY:"Копировать",DELETE:"Удалить"},REVOKED:{YOU:"Вы удалили сообщение",CONTACT:"удалил(а) сообщение"}},CONFERENCE:{JOIN:"Присоединиться",START:"Начать",RESTART:"Пересоздать конференцию",CONFIRM_RECREATE_CONF:"Вы уверены что хотите пересоздать конференцию?",CONFIRM_FINISH_CONF:"Вы уверены что хотите завершить конференцию?",PAUSE:"Остановить",FINISH:"Завершить",BACK:"Вернуться в чат",NotFoundError:"Запрошенное устройство не найдено",NotAllowedError:"В доступе  отказано. Чтобы разрешить доступ к устройству зайдите в настройки браузера",ErrorAny:"Устройство не настроено",ALLOK:"Все OK",CheckCamMic:"Проверить доступ к микрофону и камере",CheckMic:"Проверить доступ к микрофону",CheckCam:"Проверить доступ к камере",UntillTheEnd:"До окончания конференции осталось",LEFT_TIME:"Осталось"},ADD_CONTACT:"Добавить контакт",INPUT_MESSAGE:"Напишите сообщение...",INPUT_SEARCH_CONTACT:"Фамилия Имя Отчество",MEMBERS:"участников",BUT_CLOSE:"Закрыть",BUT_CONFIRM:"Да"}}},en:{translations:{CHAT:{STATUS:{ONLINE:"online",OFFLINE:"offline",TYPING:"typing"},MESSAGE:{TYPE:{IMAGE:"Image",VIDEO:"Video",FILE:"File",NOTIFY:"Notification"},MENU:{COPY:"Copy",DELETE:"Delete"},REVOKED:{YOU:"You deleted the message",CONTACT:"deleted the message"}},CONFERENCE:{JOIN:"Join",START:"Start",RESTART:"Recreate the conference",CONFIRM_RECREATE_CONF:"Are you sure you want to re-create the conference?",CONFIRM_FINISH_CONF:"Are you sure you want to end the conference?",PAUSE:"Pause",FINISH:"Finish",BACK:"Back to chat",NotFoundError:"Requested device not found",NotAllowedError:"Permission denied. To allow access to the device, go to the browser settings",ErrorAny:"The device is not configured",ALLOK:"All OK",CheckCamMic:"Check access to microphone and camera",CheckMic:"Check access to microphone",CheckCam:"Check access to camera",UntillTheEnd:"There is still time until the end of the conference",LEFT_TIME:"Time left"},ADD_CONTACT:"Add contact",INPUT_MESSAGE:"Please write a message...",INPUT_SEARCH_CONTACT:"Surname Name",MEMBERS:"members",BUT_CLOSE:"Close",BUT_CONFIRM:"Yes"}}},fr:{translations:{CHAT:{STATUS:{ONLINE:"en ligne",OFFLINE:"hors ligne",TYPING:"imprime"},MESSAGE:{TYPE:{IMAGE:"Image",VIDEO:"Vidéo",FILE:"File",NOTIFY:"Notification"},MENU:{COPY:"Copier",DELETE:"Supprimer"},REVOKED:{YOU:"Vous avez supprimé le message",CONTACT:"message supprimé"}},CONFERENCE:{JOIN:"Rejoindre",START:"Démarrer",RESTART:"Recréer la conférence",CONFIRM_RECREATE_CONF:"êtes-vous sûr de vouloir recréer la conférence?",CONFIRM_FINISH_CONF:"êtes-vous sûr de vouloir terminer la conférence?",PAUSE:"Pause",FINISH:"Terminer",BACK:"Retour au chat",NotFoundError:"Périphérique demandé introuvable",NotAllowedError:"Autorisation refusée. Pour autoriser l'accès à l'appareil, accédez aux paramètres du navigateur",ErrorAny:"L'appareil n'est pas configuré",ALLOK:"Tout va bien",CheckCamMic:"Vérifier l'accès au microphone et à la caméra",CheckMic:"Vérifier l'accès au microphone",CheckCam:"Vérifier l'accès à la caméra",UntillTheEnd:" Il est encore temps jusqu'à la fin de la conférence",LEFT_TIME:"temps restant:"},ADD_CONTACT:"Ajouter un contact",INPUT_MESSAGE:"Veuillez écrire un message...",INPUT_SEARCH_CONTACT:"Surname Name",MEMBERS:"members",BUT_CLOSE:"Fermer",BUT_CONFIRM:"Oui"}}}},lng:ut,load:"languageOnly",fallbackLng:ut,debug:!0,ns:["translations"],defaultNS:"translations",lowerCaseLng:!0});const dt=(e,t)=>{switch(t.type){case"SET_ENGLISH":return j.changeLanguage("en"),{language:"en"};case"SET_FRENCH":return j.changeLanguage("fr"),{language:"fr"};case"SET_RUSSIAN":return j.changeLanguage("ru"),{language:"ru"};default:return e}},mt=r.createContext({}),pt=e=>{let{children:t}=e;const[a,n]=r.useReducer(dt,{language:j.language.substring(0,2)}),l=r.useMemo(()=>({languageState:a,dispatchLanguage:n}),[a]);return o.createElement(mt.Provider,{value:l},o.createElement(m.I18nextProvider,{i18n:j},t))};exports.AddContact=ne,exports.ChatContext=Me,exports.ChatIndex=e=>{let{activeGroupId:t,activeChatUserId:a,hideRooms:n=!1,lang:r,chatBaseURLApi:l,chatWsUrl:s,chatWsPath:i,token:c,inModale:u=!1,refreshToken:d}=e;return o.createElement(pt,null,o.createElement(De,{defLang:r,token:c,refreshToken:d},o.createElement(nt,{baseURLApi:l,pageSize:25},o.createElement(ot,{wsUrl:s,wsPath:i},o.createElement(ct,{activeGroupId:t,activeChatUserId:a,hideRooms:n,inModale:u})))))},exports.ChatPage=ct,exports.ChatProvider=De,exports.Conference=$e,exports.ConferenceCall=Qe,exports.Emoji=H,exports.Message=Se,exports.RestContext=Ze,exports.RestProvider=nt,exports.Room=Fe,exports.RoomList=Ke,exports.SocketContext=rt,exports.SocketProvider=ot,exports.Typing=z,exports.clearLocalStorage=et,exports.getRefreshToken=at,exports.signOut=tt;
//# sourceMappingURL=chat.cjs.production.min.js.map
