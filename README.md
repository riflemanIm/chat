# PMT Chat Components

React-компоненты чата для проектов Mobimed. Пакет предоставляет готовую страницу `ChatPage` и набор переиспользуемых элементов для внедрения чата в сторонние приложения.

## Содержание
- Обзор
- Требования
- Быстрый старт
- Интеграция
- Пользовательский функционал
- Функционал для разработчиков
- Архитектура и основные модули
- Работа с API
- Локализация
- Команды npm

## Обзор
Чат построен на React 18, использует Vite для сборки, Material UI для визуальных компонентов и Socket.IO для обмена сообщениями в реальном времени. Основные сценарии включают персональную и групповую переписку, поиск по истории, работу с медиа и видеовызовы.

## Требования
- Node.js 22.x (проект и CI используют 22.9.0)
- Yarn 1 (активируется через Corepack)
- Установленные peer-зависимости: React, React DOM, i18next, React i18next, Material UI 6, Emotion

## Быстрый старт
```sh
yarn install
yarn dev      # запуск локального окружения на http://localhost:5173
yarn build    # сборка библиотеки в dist/
```
Перед запуском убедитесь, что заданы корректные значения пропсов авторизации и адресов API, иначе провайдеры REST и WebSocket не смогут подключиться к сервису.

## Интеграция
Импортируйте компонент `ChatIndex` и передайте конфигурацию чата. Он оборачивает `ChatPage` необходимыми провайдерами.

```tsx
import { ChatIndex } from "@pmt/chat";

<ChatIndex
  lang="ru"
  chatBaseURLApi="https://chat.mobimed.ru/"
  baseUrl="https://auth.mobimed.ru"
  chatWsUrl="wss://chat.mobimed.ru"
  chatWsPath="/socket.io"
  token={authToken}
  refreshToken={refreshToken}
  activeGroupId={1}
  activeChatUserId={undefined}
  hideRooms={false}
  fullWidth
/>;
```

Описание пропсов:
- `lang` — язык интерфейса (`ru`, `en`, `fr`)
- `chatBaseURLApi` — REST API чата
- `baseUrl` — сервис аутентификации, используется для обновления токенов
- `chatWsUrl` и `chatWsPath` — адрес и путь WebSocket (по умолчанию `/socket.io`)
- `token`, `refreshToken` — авторизационные токены пользователя
- `activeGroupId`, `activeChatUserId` — идентификаторы комнаты или контакта для автооткрытия
- `hideRooms` — скрыть список комнат, если необходимо встроить только диалог
- `fullWidth` — растягивает чат на всю доступную ширину
- `onContactInfoClick` — колбэк для отображения карточки контакта

## Пользовательский функционал
- Персональные и групповые чаты с отображением онлайн-статусов и количества участников.
- Поиск по истории сообщений с подсветкой найденных элементов и возможностью быстро переходить между совпадениями.
- Неограниченная прокрутка истории: загрузка сообщений порциями по 25 записей с сохранением позиции.
- Отправка текстов, эмодзи, изображений (jpeg, png, gif, bmp), видео (mp4, webm) и PDF-файлов до 10 МБ. Для изображений автоматически рассчитываются размеры предпросмотра.
- Индикация набора текста и подтверждение прочтения: чат отправляет события `typing` и `markAsRead`.
- Меню действий над сообщениями: копирование содержания, отзыв/удаление отправленного сообщения (в рамках ограничения на стороне бэкенда).
- Уведомления о новых сообщениях, бейджи непрочитанного, счетчики в списке комнат.
- Встроенные видеоконференции: вход/выход, пауза, завершение вызова, повторный запуск, отображение информации о визите пациента.
- Работа в модальном и полноэкранном режимах, адаптивная верстка для мобильных устройств.

## Функционал для разработчиков
- Провайдеры `ChatProvider`, `RestProvider`, `SocketProvider` управляют состоянием, REST-запросами и WebSocket-соединением. Их можно переиспользовать отдельно или расширить собственными обработчиками.
- `ChatContext` предоставляет глобальное состояние (список комнат, активная комната, токены, ошибки, индикаторы загрузки) и диспатчи для обновления стора.
- `RestContext` инкапсулирует клиент axios с обновлением токена по 401, экспонирует методы `getPrivateMessages`, `getGroupMessages`, `getUserByMmk`.
- `SocketContext` создает соединение Socket.IO, автоматически пересоздает сокет при смене токена или адреса и предоставляет доступ к экземпляру через React Context.
- Типы сообщений, контактов и событий описаны в `src/types`, что облегчает интеграцию в приложения TypeScript.
- Все визуальные компоненты модульно организованы в `src/components` и могут быть импортированы напрямую при необходимости собрать кастомный интерфейс.
- Стили построены на Material UI и `@mui/styles`, что позволяет переопределять тему через стандартные механизмы MUI.

## Архитектура и основные модули
- `src/components` — UI-компоненты: `Room`, `RoomList`, `Message`, `Entry`, `ConferenceSection`, `Typing`, `Emoji`, `ChatLayout` и др.
- `src/pages/ChatPage` — готовая страница чата, связывает провайдеры, списки комнат и окно сообщений.
- `src/context` — контексты состояния (`ChatContext`, `RestContext`, `SocketContext`).
- `src/hooks` — утилитарные хуки.
- `src/utils` — вспомогательные функции (формирование идентификаторов чатов, проверки типов комнат и т.д.).
- `src/translations` — словари локализации.
- `dist/` — результат сборки библиотеки (`mobimed.esm.js`, `index.cjs`, типы TypeScript).

## Работа с API
- REST: `RestProvider` обращается к `chatBaseURLApi` по маршрутам `/contact/messages`, `/group/messages`, `/contact/find`. Пагинация контролируется параметрами `current` и `pageSize`.
- WebSocket: `SocketProvider` подключается к `chatWsUrl` и обрабатывает события `privateMessage`, `groupMessage`, `typing`, `markAsRead`, `revokeMessage` и другие, реализованные на бэкенде. Отправка сообщений выполняется через `emitSocketEvent` в `ChatPage`.
- Обновление токенов: при ответе 401 REST-клиент вызывает `getRefreshToken`, отправляя `authToken` и `refreshToken` на `baseUrl/auth/refreshToken` и перезагружая страницу после получения новых значений.

## Локализация
Интерфейс переведен на русский, английский и французский языки. Словари находятся в `src/translations`, ключи подгружаются через `react-i18next`. Для добавления нового языка добавьте json-файл в каталог переводов и зарегистрируйте его в настройках i18next.

## Команды npm
- `yarn dev` — запуск Vite Dev Server.
- `yarn build` — сборка библиотеки, очистка папки `dist` выполняется через `rimraf`.

После изменения компонентов рекомендуется собрать проект (`yarn build`) и проверить, что пакеты `dist/index.cjs`, `dist/mobimed.esm.js` и `dist/index.d.ts` обновлены корректно.
